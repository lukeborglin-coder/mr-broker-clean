/* Admin page interactivity
   - Flip layout already handled by HTML order
   - "Create Client User" is collapsed until button clicked
   - Prevent browser autofill with autocomplete="off" + nonstandard names
   - Client Library as dropdown with ability to add new entries
   - Buttons share site-wide styles
*/

const $ = (s, r=document)=>r.querySelector(s);

const toggleBtn = $("#toggleCreateUser");
const form = $("#createUserForm");
const statusCreate = $("#createUserStatus");
const signOutBtn = $("#signOutBtn");

toggleBtn?.addEventListener("click", ()=>{
  form.classList.toggle("hidden");
  toggleBtn.textContent = form.classList.contains("hidden") ? "Open" : "Close";
});

signOutBtn?.addEventListener("click",(e)=>{
  e.preventDefault();
  localStorage.removeItem("AUTH_TOKEN");
  location.href="/";
});

// ----- Client Library dropdown (simple client-side store; replace with your API if available)
const selectLib = $("#clientLibrarySelect");
const addBtn = $("#addLibraryItemBtn");
const newItem = $("#newLibraryItem");
const libStatus = $("#libraryStatus");
const saveBtn = $("#saveLibraryBtn");

function loadLib() {
  try {
    const raw = localStorage.getItem("CLIENT_LIBRARY") || '["Genentech","Demo"]';
    const items = JSON.parse(raw);
    selectLib.innerHTML = "";
    items.forEach(v=>{
      const opt = document.createElement("option");
      opt.value = v; opt.textContent = v;
      selectLib.appendChild(opt);
    });
  } catch {
    selectLib.innerHTML = `<option>Demo</option>`;
  }
}
loadLib();

addBtn?.addEventListener("click", ()=>{
  const v = (newItem.value||"").trim();
  if (!v) return;
  const arr = Array.from(selectLib.options).map(o=>o.value);
  if (!arr.includes(v)) {
    const opt = document.createElement("option"); opt.value=v; opt.textContent=v;
    selectLib.appendChild(opt);
    selectLib.value = v;
    libStatus.textContent = "Added (not yet saved)";
  } else {
    libStatus.textContent = "Already exists";
  }
  newItem.value="";
});

saveBtn?.addEventListener("click", async ()=>{
  const arr = Array.from(selectLib.options).map(o=>o.value);
  localStorage.setItem("CLIENT_LIBRARY", JSON.stringify(arr));
  libStatus.textContent = "Saved";
});

// ----- Create Client User (role fixed to admin)
form?.addEventListener("submit", async (e)=>{
  e.preventDefault();
  statusCreate.textContent = "Creatingâ€¦";

  const payload = {
    username: $("#cu_username").value.trim(),
    password: $("#cu_password").value,
    role: $("#cu_role").value || "admin"
  };
  if (!payload.username || !payload.password) {
    statusCreate.textContent = "Username and password required";
    return;
  }

  try {
    const res = await fetch("/admin/create-user", {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-auth-token": (localStorage.getItem("AUTH_TOKEN") || "")
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    statusCreate.textContent = "User created";
    form.reset();
  } catch (err) {
    statusCreate.textContent = "Error: " + err.message;
  }
});
