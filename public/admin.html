<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>COGgpt — Admin</title>
  <link rel="stylesheet" href="/styles.css"/>
  <style>
    :root{
      --brand:#ff7a00; --ink:#111; --muted:#5f6570; --line:#e9edf2;
      --soft:#fff7ed; --soft-border:#ffead6;
      --danger:#b91c1c; --danger-bg:#fff1f2;
      --link:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#fff;color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
    .bar{max-width:1080px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:baseline;gap:6px}
    .brand .cog{font-weight:800;color:#2b2f36;font-size:24px;letter-spacing:.1px}
    .brand .gpt{font-weight:400;color:var(--brand);font-size:24px;margin-left:-2px}
    .brand .beta{font-size:.78rem;color:#9aa2ad;font-weight:700;letter-spacing:.06em}
    .nav{display:flex;align-items:center;gap:10px}
    #who{color:var(--muted);font-size:.85rem}

    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:10px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.small{padding:10px 14px;font-size:.92rem;line-height:1;height:40px}
    .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--line)}
    .btn.ghost:hover{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.primary{background:var(--brand);color:#fff;border:0;padding:12px 18px;border-radius:12px}

    /* 2/3 : 1/3 layout */
    .grid{max-width:1080px;margin:28px auto;padding:0 16px;display:grid;gap:18px;grid-template-columns:2fr 1fr}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .card{border:1px solid var(--line);border-radius:14px;padding:14px;background:#fff}
    .card h2{margin:0 0 6px;font-size:1.1rem}
    .muted{color:var(--muted)}
    .soft{background:var(--soft);border-color:var(--soft-border)}

    /* Tree list — no nested boxes */
    .tree{list-style:none;padding-left:0;margin:0}
    .tree details{border:0;margin:6px 0;padding:0}
    .tree summary{cursor:pointer;font-weight:600;list-style:none}
    .tree summary::-webkit-details-marker{display:none}
    .tree ul{list-style:disc;padding-left:20px;margin:6px 0 0}
    .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:.8rem;color:var(--muted);margin-left:8px}

    /* Selects/inputs */
    .row{display:flex;gap:10px;flex-wrap:wrap}
    select, input{border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:.95rem}
    label{font-size:.9rem;color:var(--muted)}

    /* Account lists (show ~5, scroll for more) */
    .list{border:1px solid var(--line);border-radius:10px;padding:6px 8px;max-height:220px;overflow:auto}
    .acct{display:flex;align-items:center;justify-content:space-between;padding:6px 6px;border-bottom:1px solid #f2f4f7}
    .acct:last-child{border-bottom:0}
    .kill{color:var(--danger);background:transparent;border:0;font-weight:900;font-size:16px;cursor:pointer;border-radius:6px;padding:2px 6px}
    .kill:hover{background:var(--danger-bg)}
    .link{color:var(--link);text-decoration:underline;cursor:pointer;font-size:.9rem}
    .hidden{display:none}
    .tiny{font-size:.85rem}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <span class="cog">COG</span><span class="gpt">gpt</span><span class="beta">(BETA)</span>
      </div>
      <div class="nav">
        <div id="who"></div>
        <a class="btn small ghost" href="/">Home</a>
        <button id="logoutBtn" class="btn small ghost" title="Sign out">Sign Out</button>
      </div>
    </div>
  </header>

  <main class="grid">
    <!-- LEFT 2/3 -->
    <section>
      <!-- Available Client Libraries -->
      <section class="card">
        <h2>Available Client Libraries</h2>
        <div class="muted tiny" id="libsNote">Click a library to view its folders, then click a folder to view file names.</div>
        <ul id="libsTree" class="tree" style="margin-top:8px;"></ul>
        <div id="libsMsg" class="muted"></div>
      </section>

      <!-- Library Stats -->
      <section class="card">
        <h2>Library Stats</h2>
        <div class="row">
          <select id="statsClient"><option value="">Select a client library</option></select>
        </div>
        <div id="statsOut" class="soft" style="margin-top:10px;padding:10px 12px;border-radius:10px;"></div>
      </section>

      <!-- Update Library -->
      <section class="card">
        <h2>Update Library</h2>
        <div class="row">
          <select id="ingestClient"><option value="">Select a client library</option></select>
          <button id="ingestBtn" class="btn small ghost">Update</button>
        </div>
        <div id="ingestOut" class="soft" style="margin-top:10px;padding:10px 12px;border-radius:10px;"></div>
      </section>
    </section>

    <!-- RIGHT 1/3 -->
    <aside>
      <!-- Client Accounts -->
      <section class="card">
        <h2>Client Accounts</h2>
        <div class="list" id="clientList"></div>
        <div style="margin-top:8px;">
          <span id="addClientLink" class="link">Add New Account</span>
        </div>
        <div id="clientForm" class="hidden" style="margin-top:10px;">
          <div class="row">
            <div style="flex:1;min-width:200px;">
              <label>Username</label>
              <input id="cu_username" autocomplete="off" placeholder="client_username"/>
            </div>
            <div style="flex:1;min-width:200px;">
              <label>Password</label>
              <input id="cu_password" type="password" autocomplete="new-password" placeholder="Set password"/>
            </div>
            <div style="flex:1;min-width:200px;">
              <label>Confirm</label>
              <input id="cu_confirm" type="password" autocomplete="new-password" placeholder="Confirm password"/>
            </div>
          </div>
          <div class="row" style="margin-top:8px;">
            <div style="flex:1;min-width:220px;">
              <label>Assign To Client Library</label>
              <select id="cu_client"><option value="">Select a client library</option></select>
            </div>
          </div>
          <div style="margin-top:10px;">
            <button id="createClientBtn" class="btn primary">Create</button>
            <span id="createClientMsg" class="muted" style="margin-left:8px;"></span>
          </div>
        </div>
      </section>

      <!-- Admin Accounts -->
      <section class="card">
        <h2>Admin Accounts</h2>
        <div class="list" id="adminList"></div>
        <div style="margin-top:8px;">
          <span id="addAdminLink" class="link">Add New Admin</span>
        </div>
        <div id="adminForm" class="hidden" style="margin-top:10px;">
          <div class="row">
            <div style="flex:1;min-width:200px;">
              <label>Username</label>
              <input id="au_username" autocomplete="off" placeholder="admin_username"/>
            </div>
            <div style="flex:1;min-width:200px;">
              <label>Password</label>
              <input id="au_password" type="password" autocomplete="new-password" placeholder="Set password"/>
            </div>
            <div style="flex:1;min-width:200px;">
              <label>Confirm</label>
              <input id="au_confirm" type="password" autocomplete="new-password" placeholder="Confirm password"/>
            </div>
          </div>
          <div style="margin-top:10px;">
            <button id="createAdminBtn" class="btn primary">Create</button>
            <span id="createAdminMsg" class="muted" style="margin-left:8px;"></span>
          </div>
        </div>
      </section>
    </aside>
  </main>

<script>
(async function init(){
  // whoami & logout
  try{
    const meRes = await fetch("/me");
    if (meRes.ok) {
      const me = await meRes.json();
      document.getElementById("who").textContent = `${me.user.username} · ${me.user.role}`;
    }
  }catch{}
  document.getElementById("logoutBtn").onclick = async ()=>{ await fetch("/auth/logout",{method:"POST"}); location.href="/login.html"; };

  // libraries for selects & tree
  const libs = await (await fetch("/api/client-libraries")).json();
  const libSelects = ["cu_client","statsClient","ingestClient"].map(id=>document.getElementById(id));
  for (const s of libSelects) {
    if (!s) continue;
    s.innerHTML = '<option value="">Select a client library</option>';
    libs.forEach(l=>{
      const o=document.createElement("option"); o.value=l.id; o.textContent=l.name; s.appendChild(o);
    });
  }

  // ---- Library tree (folders -> files) (no nested borders)
  const libsTree = document.getElementById("libsTree");
  const libsMsg = document.getElementById("libsMsg");
  libsMsg.textContent = libs.length ? "" : "No libraries found.";
  libs.forEach(lib=>{
    const li = document.createElement("li");
    const details = document.createElement("details");
    const summary = document.createElement("summary");
    summary.textContent = lib.name;
    const pill = document.createElement("span"); pill.className="pill"; pill.textContent="library";
    summary.appendChild(pill);
    details.appendChild(summary);
    const container = document.createElement("div");
    container.className = "muted"; container.textContent = "Loading folders…";
    details.appendChild(container);
    details.addEventListener("toggle", async ()=>{
      if (!details.open) return;
      container.textContent="Loading folders…";
      try{
        const r = await fetch(`/admin/drive/children?parentId=${encodeURIComponent(lib.id)}`);
        const j = await r.json();
        if (!r.ok) throw new Error(j.error||"error");
        const ul = document.createElement("ul"); ul.className="tree";
        (j.folders||[]).forEach(f=>{
          const d = document.createElement("details");
          const s = document.createElement("summary"); s.textContent=f.name;
          const fp = document.createElement("span"); fp.className="pill"; fp.textContent="folder"; s.appendChild(fp);
          d.appendChild(s);
          const inner = document.createElement("div"); inner.className="muted"; inner.textContent="Loading…"; d.appendChild(inner);
          d.addEventListener("toggle", async ()=>{
            if (!d.open) return;
            inner.textContent="Loading…";
            const rr = await fetch(`/admin/drive/children?parentId=${encodeURIComponent(f.id)}`);
            const jj = await rr.json();
            if (!rr.ok) { inner.textContent = jj.error || "Error"; return; }
            const list = document.createElement("ul");
            // one more subfolder level
            (jj.folders||[]).forEach(sf=>{
              const d2=document.createElement("details");
              const s2=document.createElement("summary"); s2.textContent=sf.name;
              const p2=document.createElement("span"); p2.className="pill"; p2.textContent="folder"; s2.appendChild(p2);
              d2.appendChild(s2);
              const inner2=document.createElement("div"); inner2.className="muted"; inner2.textContent="Loading…"; d2.appendChild(inner2);
              d2.addEventListener("toggle", async ()=>{
                if (!d2.open) return;
                inner2.textContent="Loading…";
                const r3 = await fetch(`/admin/drive/children?parentId=${encodeURIComponent(sf.id)}`);
                const j3 = await r3.json();
                if (!r3.ok) { inner2.textContent=j3.error||"Error"; return; }
                const l3=document.createElement("ul");
                (j3.files||[]).forEach(file=>{ const it=document.createElement("li"); it.textContent=file.name; l3.appendChild(it); });
                inner2.innerHTML=""; l3.children.length ? inner2.appendChild(l3) : inner2.textContent="No files.";
              });
              const lii=document.createElement("li"); lii.appendChild(d2); list.appendChild(lii);
            });
            (jj.files||[]).forEach(file=>{ const liF=document.createElement("li"); liF.textContent=file.name; list.appendChild(liF); });
            inner.innerHTML=""; list.children.length ? inner.appendChild(list) : inner.textContent="Empty.";
          });
          const liF=document.createElement("li"); liF.appendChild(d); ul.appendChild(liF);
        });
        (j.files||[]).forEach(file=>{ const liF=document.createElement("li"); liF.textContent=file.name; ul.appendChild(liF); });
        container.innerHTML=""; ul.children.length ? container.appendChild(ul) : container.textContent="Empty.";
      }catch(e){ container.textContent="Failed to load."; }
    });
    li.appendChild(details); libsTree.appendChild(li);
  });

  // ---- Stats (auto-load on select change, no Refresh button)
  const statsSelect = document.getElementById("statsClient");
  statsSelect.addEventListener("change", loadStats);
  async function loadStats(){
    const clientId = statsSelect.value;
    const out = document.getElementById("statsOut");
    if (!clientId) { out.textContent="Select a client."; return; }
    out.textContent="Loading…";
    const r = await fetch(`/admin/library-stats?clientId=${encodeURIComponent(clientId)}`);
    const j = await r.json();
    if (!r.ok) { out.textContent = j.error || "Error"; return; }
    const accounts = (j.accounts||[]).map(a=>`${a.username}${a.role==="internal"?" (admin)":""}`).join(", ");
    out.innerHTML = `
      <div><strong>Drive files:</strong> ${j.driveFiles ?? "—"}</div>
      <div><strong>Reports:</strong> ${j.reportsCount ?? 0}</div>
      <div><strong>Data files:</strong> ${j.dataFilesCount ?? 0}</div>
      <div><strong>QNRs:</strong> ${j.qnrsCount ?? 0}</div>
      <div style="margin-top:8px;"><strong>Accounts with access:</strong> ${accounts || "None"}</div>
    `;
  }

  // ---- Update Library (ingest)
  document.getElementById("ingestBtn").onclick = async ()=>{
    const clientId = document.getElementById("ingestClient").value;
    const out = document.getElementById("ingestOut");
    if (!clientId) { out.textContent="Select a client."; return; }
    out.textContent="Updating…";
    const r = await fetch("/admin/ingest-client",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ clientId })});
    const j = await r.json();
    out.textContent = r.ok ? `OK. Upserted: ${j.summary?.upserted ?? 0}` : (j.error || "Error");
  };

  // ---- Accounts (lists + add + delete)
  const users = await (await fetch("/admin/users/list")).json();

  function appendAccountRow(container, user){
    const row = document.createElement("div");
    row.className="acct";
    row.innerHTML = `<span>${user.username}</span>`;
    const del = document.createElement("button");
    del.className="kill"; del.title="remove account access"; del.textContent="×";
    del.onclick = async ()=>{
      const ok = confirm(`Are you sure you want to remove account access for ${user.username}?`);
      if (!ok) return;
      const r = await fetch("/admin/users/delete", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ username: user.username })});
      if (r.ok) { row.remove(); } else { alert("Failed to remove account."); }
    };
    row.appendChild(del);
    container.prepend(row); // most recent at top
  }

  function renderAccounts(role, listId){
    const el = document.getElementById(listId);
    const arr = users.filter(u => role==="client" ? u.role!=="internal" : u.role==="internal");
    const ordered = arr.slice().reverse(); // newest first
    el.innerHTML = "";
    ordered.forEach(u => appendAccountRow(el, u));
  }

  renderAccounts("client","clientList");
  renderAccounts("admin","adminList");

  // Add client account (expand form)
  const clientForm = document.getElementById("clientForm");
  document.getElementById("addClientLink").onclick = ()=> clientForm.classList.toggle("hidden");
  document.getElementById("createClientBtn").onclick = async ()=>{
    const username = document.getElementById("cu_username").value.trim();
    const password = document.getElementById("cu_password").value;
    const confirmPassword = document.getElementById("cu_confirm").value;
    const clientFolderId = document.getElementById("cu_client").value;
    const msg = document.getElementById("createClientMsg"); msg.textContent = "…";
    const r = await fetch("/admin/users/create",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ username, password, confirmPassword, clientFolderId, role:"client" })});
    const j = await r.json();
    if (r.ok && j.user){
      users.push(j.user);
      appendAccountRow(document.getElementById("clientList"), j.user);
      msg.textContent = "Created.";
      clientForm.classList.add("hidden");
      document.getElementById("cu_username").value="";
      document.getElementById("cu_password").value="";
      document.getElementById("cu_confirm").value="";
      document.getElementById("cu_client").value="";
    } else {
      msg.textContent = j.error || "Failed.";
    }
  };

  // Add admin account
  const adminForm = document.getElementById("adminForm");
  document.getElementById("addAdminLink").onclick = ()=> adminForm.classList.toggle("hidden");
  document.getElementById("createAdminBtn").onclick = async ()=>{
    const username = document.getElementById("au_username").value.trim();
    const password = document.getElementById("au_password").value;
    const confirmPassword = document.getElementById("au_confirm").value;
    const msg = document.getElementById("createAdminMsg"); msg.textContent = "…";
    // clientFolderId is ignored for admins by backend; send any placeholder
    const r = await fetch("/admin/users/create",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ username, password, confirmPassword, clientFolderId: "ALL", role:"admin" })});
    const j = await r.json();
    if (r.ok && j.user){
      users.push(j.user);
      appendAccountRow(document.getElementById("adminList"), j.user);
      msg.textContent = "Created.";
      adminForm.classList.add("hidden");
      document.getElementById("au_username").value="";
      document.getElementById("au_password").value="";
      document.getElementById("au_confirm").value="";
    } else {
      msg.textContent = j.error || "Failed.";
    }
  };
})();
</script>
</body>
</html>
