<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="page">

    <!-- Header -->
    <header class="header">
      <h1 class="title">
        <span class="title-cog">Admin</span>
      </h1>
      <div class="header-actions">
        <a class="cg-btn" href="/index.html">Home</a>
        <button class="cg-btn" id="signOutBtn" type="button">Sign out</button>
      </div>
    </header>

    <!-- Two-column admin grid -->
    <section class="cg-admin-grid">

      <!-- LEFT: Update Client Library -->
      <div class="panel">
        <h3>Update Client Library</h3>
        <label for="libSelect" class="label text-sm">LIBRARY</label>
        <select id="libSelect" class="select text-sm">
          <option value="" disabled selected>Select...</option>
        </select>
        <div style="margin-top:12px;">
          <button class="cg-btn" id="btnUpdate">Update Library</button>
        </div>
      </div>

      <!-- RIGHT: Users -->
      <div class="panel">
        <h3>Users</h3>

        <button class="cg-btn" id="toggleCreate" type="button">Create client user</button>

        <div id="createPanel" class="cg-panel-toggle">
          <form id="createForm" class="form-grid" autocomplete="off" style="margin-top:10px;">
            <!-- dummy fields to deter autofill -->
            <input type="text" class="hidden" aria-hidden="true">
            <input type="password" class="hidden" aria-hidden="true">

            <div>
              <label class="label text-sm" for="newUser">Username</label>
              <input id="newUser" class="input cg-readonly" type="text" autocomplete="off" placeholder="username" />
            </div>

            <div>
              <label class="label text-sm" for="newPass">Password</label>
              <input id="newPass" class="input cg-readonly" type="password" autocomplete="new-password" placeholder="new password" />
            </div>

            <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
              <button class="cg-btn" type="submit">Save</button>
              <button class="cg-btn ghost" type="button" id="cancelCreate">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="small">Role: <strong>admin</strong></div>
    </section>
  </div>

  <!-- Optional: reuse password gate on admin -->
  <div id="cgGate" class="cg-gate" role="dialog" aria-modal="true">
    <div class="cg-panel">
      <h3>Enter Admin Password</h3>
      <p class="muted">Restricted page.</p>
      <form id="cgGateForm" autocomplete="off">
        <input type="text" class="hidden" aria-hidden="true">
        <input type="password" class="hidden" aria-hidden="true">

        <label class="cg-label" for="cgGatePwd">Password</label>
        <input id="cgGatePwd" class="input cg-readonly" type="password" autocomplete="new-password" placeholder="Password" />
        <button class="cg-btn block" type="submit" style="margin-top:12px;">Continue</button>
      </form>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    // ---- gate (same password as main)
    const GATE_KEY = "cg_gate_ok_v1";
    const gate = $("#cgGate");
    function gateOk() { return sessionStorage.getItem(GATE_KEY) === "1"; }
    function markGateOk() { sessionStorage.setItem(GATE_KEY, "1"); }
    function showGate() { gate.classList.add("open"); }
    function hideGate() { gate.classList.remove("open"); }
    (function setupGate(){
      const pwd = $("#cgGatePwd");
      pwd.setAttribute("readonly", "readonly");
      pwd.addEventListener("focus", () => pwd.removeAttribute("readonly"), { once: true });
      $("#cgGateForm").addEventListener("submit", (e) => {
        e.preventDefault();
        if (pwd.value.trim() === "coggpt25") { markGateOk(); hideGate(); }
        else alert("Incorrect password");
      });
      if (!gateOk()) showGate();
      $("#signOutBtn")?.addEventListener("click", () => { sessionStorage.removeItem(GATE_KEY); showGate(); });
    })();

    // ---- populate library options
    (async function loadLibraries() {
      const sel = $("#libSelect");
      const endpoints = ["/clients", "/admin/clients", "/api/clients"];
      for (const ep of endpoints) {
        try {
          const r = await fetch(ep);
          if (r.ok) {
            const data = await r.json();
            if (Array.isArray(data)) {
              for (const name of data) {
                const opt = document.createElement("option");
                opt.value = name; opt.textContent = name; sel.appendChild(opt);
              }
              break;
            }
          }
        } catch (_) {}
      }
    })();

    // ---- toggle create panel
    const panel = $("#createPanel");
    $("#toggleCreate").addEventListener("click", () => panel.classList.toggle("open"));
    $("#cancelCreate").addEventListener("click", () => panel.classList.remove("open"));

    // defeat autofill until focus
    for (const id of ["newUser","newPass"]) {
      const el = document.getElementById(id);
      el.setAttribute("readonly", "readonly");
      el.addEventListener("focus", () => el.removeAttribute("readonly"), { once: true });
    }

    // ---- save new user (placeholder; wire to your backend)
    $("#createForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = $("#newUser").value.trim();
      const password = $("#newPass").value;
      if (!username || !password) { alert("Enter username and password"); return; }
      try {
        const r = await fetch("/admin/users", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password, role: "admin" })
        });
        if (!r.ok) throw new Error("Failed to create user");
        alert("Created!");
        panel.classList.remove("open");
        $("#newUser").value = ""; $("#newPass").value = "";
      } catch (err) { alert(err.message); }
    });

    // ---- update library (placeholder; wire to your backend)
    $("#btnUpdate").addEventListener("click", async () => {
      const lib = $("#libSelect").value;
      if (!lib) { alert("Select a library first"); return; }
      try {
        const r = await fetch(`/admin/library/update`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ library: lib })
        });
        if (!r.ok) throw new Error("Update failed");
        alert("Library update started");
      } catch (err) { alert(err.message); }
    });
  </script>
</body>
</html>
