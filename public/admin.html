<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>COGgpt — Admin</title>
  <link rel="stylesheet" href="/styles.css"/>
  <style>
    :root{
      --brand:#ff7a00; --ink:#111; --muted:#5f6570; --line:#e9edf2;
      --soft:#fff7ed; --soft-border:#ffead6;
      --danger:#b91c1c; --danger-bg:#fff1f2;
      --link:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#fff;color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}

    /* Full-width header bar */
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
    .bar{max-width:none;width:100%;margin:0;padding:12px 24px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:baseline;gap:6px}
    .brand .cog{font-weight:800;color:#2b2f36;font-size:24px;letter-spacing:.1px}
    .brand .gpt{font-weight:400;color:var(--brand);font-size:24px;margin-left:-2px}
    .brand .beta{font-size:.78rem;color:#9aa2ad;font-weight:700;letter-spacing:.06em}
    .nav{display:flex;align-items:center;gap:10px}
    #who{color:var(--muted);font-size:.85rem}

    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:10px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.small{padding:10px 14px;font-size:.92rem;line-height:1;height:40px}
    .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--line)}
    .btn.ghost:hover{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.primary{background:var(--brand);color:#fff;border:0;padding:12px 18px;border-radius:12px}

    /* Full-width main grid with more spacing between cards */
    .grid{max-width:none;width:100%;margin:28px 0;padding:0 24px;display:grid;gap:24px;grid-template-columns:2fr 1fr}
    @media (max-width: 1100px){ .grid{grid-template-columns:1fr} }

    .card{border:1px solid var(--line);border-radius:14px;padding:16px;background:#fff}
    .card h2{margin:0 0 8px;font-size:1.1rem}
    .muted{color:var(--muted)}
    .soft{background:var(--soft);border-color:var(--soft-border)}

    /* Tree list */
    .tree{list-style:none;padding-left:0;margin:0}
    .tree details{border:1px solid var(--line);border-radius:10px;margin:8px 0;padding:8px 10px}
    .tree summary{cursor:pointer;font-weight:600}
    .tree ul{list-style:disc;padding-left:20px;margin:6px 0 0}
    .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:.8rem;color:var(--muted);margin-left:8px}

    /* Selects/inputs */
    .row{display:flex;gap:10px;flex-wrap:wrap}
    select, input{border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:.95rem}
    label{font-size:.9rem;color:var(--muted)}

    /* Username-only lists with collapsible details */
    .list{border:1px solid var(--line);border-radius:10px;padding:6px 8px;max-height:260px;overflow:auto}
    .user-item{border:1px solid #eef1f5;border-radius:10px;margin:6px 0;padding:8px 10px}
    .user-item summary{cursor:pointer;font-weight:700}
    .user-meta{margin-top:6px;color:#374151}
    .link{color:var(--link);text-decoration:underline;cursor:pointer;font-size:.95rem}
    .tiny{font-size:.85rem;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <span class="cog">COG</span><span class="gpt">gpt</span><span class="beta">(BETA)</span>
      </div>
      <div class="nav">
        <div id="who"></div>
        <a class="btn small ghost" href="/">Home</a>
        <button id="logoutBtn" class="btn small ghost" title="Sign out">Sign out</button>
      </div>
    </div>
  </header>

  <main class="grid">
    <!-- LEFT 2/3 -->
    <section>
      <!-- Available libraries -->
      <section class="card">
        <h2>Available client libraries</h2>
        <div class="tiny" id="libsNote">Click a library to view its folders, then click a folder to view file names.</div>
        <ul id="libsTree" class="tree" style="margin-top:8px;"></ul>
        <div id="libsMsg" class="muted"></div>
      </section>

      <!-- Library stats -->
      <section class="card">
        <h2>Library stats</h2>
        <div class="row">
          <select id="statsClient"><option value="">Select a client library</option></select>
        </div>
        <div id="statsOut" class="soft" style="margin-top:10px;padding:10px 12px;border-radius:10px;"></div>
      </section>

      <!-- Update Library (ingest) -->
      <section class="card">
        <h2>Update Library</h2>
        <div class="row">
          <select id="ingestClient"><option value="">Select a client library</option></select>
          <button id="ingestBtn" class="btn small ghost">Update</button>
        </div>
        <div id="ingestOut" class="soft" style="margin-top:10px;padding:10px 12px;border-radius:10px;"></div>
      </section>
    </section>

    <!-- RIGHT 1/3 -->
    <aside>
      <!-- Client Accounts -->
      <section class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <h2 style="margin:0;">Client Accounts</h2>
          <span id="addClientLink" class="link tiny">Add new</span>
        </div>
        <div id="clientForm" class="tiny" style="display:none;margin-top:10px;">
          <div class="row">
            <div style="flex:1;min-width:200px;">
              <label>Username</label>
              <input id="cu_username" autocomplete="off" placeholder="client_username"/>
            </div>
            <div style="flex:1;min-width:200px;">
              <label>Password</label>
              <input id="cu_password" type="password" autocomplete="new-password" placeholder="Set password"/>
            </div>
            <div style="flex:1;min-width:220px;">
              <label>Assign to client library</label>
              <select id="cu_client"><option value="">Select a client library</option></select>
            </div>
          </div>
          <div style="margin-top:10px;">
            <button id="createClientBtn" class="btn primary">Create</button>
            <span id="createClientMsg" class="muted" style="margin-left:8px;"></span>
          </div>
        </div>
        <div class="list" id="clientList" style="margin-top:10px;"></div>
      </section>

      <!-- Admin Accounts -->
      <section class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <h2 style="margin:0;">Admin Accounts</h2>
          <span id="addAdminLink" class="link tiny">Add new</span>
        </div>
        <div id="adminForm" class="tiny" style="display:none;margin-top:10px;">
          <div class="row">
            <div style="flex:1;min-width:200px;">
              <label>Username</label>
              <input id="au_username" autocomplete="off" placeholder="admin_username"/>
            </div>
            <div style="flex:1;min-width:200px;">
              <label>Password</label>
              <input id="au_password" type="password" autocomplete="new-password" placeholder="Set password"/>
            </div>
          </div>
          <div style="margin-top:10px;">
            <button id="createAdminBtn" class="btn primary">Create</button>
            <span id="createAdminMsg" class="muted" style="margin-left:8px;"></span>
          </div>
        </div>
        <div class="list" id="adminList" style="margin-top:10px;"></div>
      </section>
    </aside>
  </main>

<script>
let LIBS = [];
let USERS = [];

// whoami & logout
(async function init(){
  try{
    const meRes = await fetch("/me");
    if (meRes.ok) {
      const me = await meRes.json();
      document.getElementById("who").textContent = `${me.user.username} · ${me.user.role}`;
    }
  }catch{}
  document.getElementById("logoutBtn").onclick = async ()=>{ await fetch("/auth/logout",{method:"POST"}); location.href="/login.html"; };

  // libraries for selects & tree
  LIBS = await (await fetch("/api/client-libraries")).json();
  ["cu_client","statsClient","ingestClient"].forEach(id=>{
    const s=document.getElementById(id);
    if(!s) return;
    s.innerHTML = '<option value="">Select a client library</option>';
    LIBS.forEach(l=>{ const o=document.createElement("option"); o.value=l.id; o.textContent=l.name; s.appendChild(o); });
  });
  buildLibraryTree();

  // Stats auto-load on change
  document.getElementById("statsClient").addEventListener("change", loadStats);

  // Ingest/Update
  document.getElementById("ingestBtn").onclick = async ()=>{
    const clientId = document.getElementById("ingestClient").value;
    const out = document.getElementById("ingestOut");
    if (!clientId) { out.textContent="Select a client."; return; }
    out.textContent="Updating…";
    const r = await fetch("/admin/ingest-client",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ clientId })});
    const j = await r.json();
    out.textContent = r.ok ? `OK. Upserted: ${j.summary?.upserted ?? 0}` : (j.error || "Error");
  };

  // Accounts toggle form links
  const clientForm = document.getElementById("clientForm");
  document.getElementById("addClientLink").onclick = ()=> clientForm.style.display = clientForm.style.display==="none" ? "block" : "none";
  const adminForm = document.getElementById("adminForm");
  document.getElementById("addAdminLink").onclick = ()=> adminForm.style.display = adminForm.style.display==="none" ? "block" : "none";

  // Load users & render lists
  await refreshUsers();

  // Create client
  document.getElementById("createClientBtn").onclick = async ()=>{
    const username = document.getElementById("cu_username").value.trim();
    const password = document.getElementById("cu_password").value;
    const clientFolderId = document.getElementById("cu_client").value;
    const msg = document.getElementById("createClientMsg"); msg.textContent = "…";
    const r = await fetch("/admin/users/create",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ username, password, confirmPassword: password, clientFolderId, role:"client" })});
    const j = await r.json();
    if (r.ok) {
      msg.textContent = "Created.";
      document.getElementById("cu_username").value="";
      document.getElementById("cu_password").value="";
      document.getElementById("cu_client").value="";
      await refreshUsers(true);
    } else {
      msg.textContent = j.error || "Failed.";
    }
  };

  // Create admin (server will be updated to not require a client folder)
  document.getElementById("createAdminBtn").onclick = async ()=>{
    const username = document.getElementById("au_username").value.trim();
    const password = document.getElementById("au_password").value;
    const msg = document.getElementById("createAdminMsg"); msg.textContent = "…";
    const r = await fetch("/admin/users/create",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ username, password, confirmPassword: password, clientFolderId: "", role:"admin" })});
    const j = await r.json();
    if (r.ok) {
      msg.textContent = "Created.";
      document.getElementById("au_username").value="";
      document.getElementById("au_password").value="";
      await refreshUsers(true);
    } else {
      msg.textContent = j.error || "Failed.";
    }
  };
})();

// ---------- Library helpers ----------
function libNameById(id){
  if (!id || id==="*") return "All libraries";
  const f = LIBS.find(l=>l.id===id);
  return f ? f.name : id;
}
async function buildLibraryTree(){
  const libsTree = document.getElementById("libsTree");
  const libsMsg = document.getElementById("libsMsg");
  libsTree.innerHTML = "";
  libsMsg.textContent = LIBS.length ? "" : "No libraries found.";
  LIBS.forEach(lib=>{
    const li = document.createElement("li");
    const details = document.createElement("details");
    const summary = document.createElement("summary");
    summary.textContent = lib.name;
    const pill = document.createElement("span"); pill.className="pill"; pill.textContent="library";
    summary.appendChild(pill);
    details.appendChild(summary);
    const container = document.createElement("div");
    container.className = "muted"; container.textContent = "Loading folders…";
    details.appendChild(container);
    details.addEventListener("toggle", async ()=>{
      if (!details.open) return;
      container.textContent="Loading folders…";
      try{
        const r = await fetch(`/admin/drive/children?parentId=${encodeURIComponent(lib.id)}`);
        const j = await r.json();
        if (!r.ok) throw new Error(j.error||"error");
        const ul = document.createElement("ul"); ul.className="tree";
        (j.folders||[]).forEach(f=>{
          const d = document.createElement("details");
          const s = document.createElement("summary"); s.textContent=f.name;
          const fp = document.createElement("span"); fp.className="pill"; fp.textContent="folder"; s.appendChild(fp);
          d.appendChild(s);
          const inner = document.createElement("div"); inner.className="muted"; inner.textContent="Loading…"; d.appendChild(inner);
          d.addEventListener("toggle", async ()=>{
            if (!d.open) return;
            inner.textContent="Loading…";
            const rr = await fetch(`/admin/drive/children?parentId=${encodeURIComponent(f.id)}`);
            const jj = await rr.json();
            if (!rr.ok) { inner.textContent = jj.error || "Error"; return; }
            const list = document.createElement("ul");
            (jj.files||[]).forEach(file=>{ const liF=document.createElement("li"); liF.textContent=file.name; list.appendChild(liF); });
            inner.innerHTML=""; list.children.length ? inner.appendChild(list) : inner.textContent="No files.";
          });
          const liF=document.createElement("li"); liF.appendChild(d); ul.appendChild(liF);
        });
        (j.files||[]).forEach(file=>{ const liF=document.createElement("li"); liF.textContent=file.name; ul.appendChild(liF); });
        container.innerHTML=""; ul.children.length ? container.appendChild(ul) : container.textContent="Empty.";
      }catch(e){ container.textContent="Failed to load."; }
    });
    li.appendChild(details); libsTree.appendChild(li);
  });
}

// ---------- Stats ----------
async function loadStats(){
  const clientId = document.getElementById("statsClient").value;
  const out = document.getElementById("statsOut");
  if (!clientId) { out.textContent="Select a client."; return; }
  out.textContent="Loading…";
  const r = await fetch(`/admin/library-stats?clientId=${encodeURIComponent(clientId)}`);
  const j = await r.json();
  out.innerHTML = r.ok
    ? `<div><strong>Drive files:</strong> ${j.driveCount ?? "—"}</div>
       <div><strong>Library (manifest) files:</strong> ${j.libraryCount ?? "—"}</div>`
    : (j.error || "Error");
}

// ---------- Users ----------
async function refreshUsers(scrollTop=false){
  USERS = await (await fetch("/admin/users/list")).json();
  renderUserList("client");
  renderUserList("admin");
  if (scrollTop) {
    document.getElementById("clientList").scrollTop = 0;
    document.getElementById("adminList").scrollTop = 0;
  }
}

function renderUserList(kind){
  const container = document.getElementById(kind==="admin" ? "adminList" : "clientList");
  container.innerHTML = "";
  const isAdminRole = (u)=> u.role === "internal";
  const filtered = USERS.filter(u => kind==="admin" ? isAdminRole(u) : !isAdminRole(u)).slice().reverse(); // newest first
  filtered.forEach(u=>{
    const details = document.createElement("details");
    details.className = "user-item";
    const summary = document.createElement("summary");
    summary.textContent = u.username;
    details.appendChild(summary);

    const meta = document.createElement("div");
    meta.className = "user-meta";
    const lib = u.allowedClients === "*" ? "All libraries" : libNameById(u.allowedClients || "");
    meta.innerHTML = `
      <div><strong>Library:</strong> ${lib}</div>
      <div><strong>Password:</strong> <span class="tiny">not retrievable (stored securely)</span></div>
      <div style="margin-top:6px;"><a class="link" data-del="${u.username}">Delete Account</a></div>
    `;
    details.appendChild(meta);

    container.appendChild(details);
  });

  // wire delete links
  container.querySelectorAll('[data-del]').forEach(a=>{
    a.addEventListener('click', async (e)=>{
      e.preventDefault();
      const username = a.getAttribute('data-del');
      if (!confirm(`Delete account "${username}"?`)) return;
      const r = await fetch("/admin/users/delete", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ username })});
      if (r.ok) {
        await refreshUsers(true);
      } else {
        alert("Failed to remove account.");
      }
    });
  });
}
</script>
</body>
</html>
