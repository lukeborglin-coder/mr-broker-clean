<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>COGgpt — Research Q&A</title>
  <link rel="stylesheet" href="/styles.css" />
  <!-- Chart.js for quick visuals -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* small helpers so you don’t need to touch styles.css */
    .charts-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:16px; }
    .chart-card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.06); }
    .chart-card h4 { margin:0 0 8px 0; font-size:14px; color:#333; }
    .ref-list { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:12px; }
    .ref-item { background:#fff; border-radius:12px; padding:14px; box-shadow:0 2px 10px rgba(0,0,0,.06); }
    .ref-item a { text-decoration:none; color:#0b6bcb; }
    .muted { color:#666; font-size:12px; }
  </style>
</head>
<body>
  <div class="page">
    <!-- Header -->
    <header class="header">
      <h1 class="title">COG<span style="color:#ff7a00;">gpt</span></h1>
      <img src="/assets/Cog_OUTLOOK_SIG.png" alt="Cognitive Consulting" class="logo-small" />
    </header>

    <!-- Search -->
    <section class="search">
      <form id="qform">
        <input id="q" type="text" placeholder="ask a question about your research…" autocomplete="off"
               value="what is Evrysdi’s trending satisfaction?" />
        <button id="ask" type="submit">Ask</button>
      </form>
    </section>

    <!-- Answer -->
    <section id="answer" class="callout" style="display:none;"></section>

    <!-- Supporting Detail -->
    <section class="panel">
      <h3>Supporting Detail</h3>
      <ul id="bullets"></ul>
    </section>

    <!-- Supporting Quotes (fixed formatting) -->
    <section class="panel">
      <h3>Supporting Quotes</h3>
      <ul id="quotes"></ul>
    </section>

    <!-- Visuals + Source Slides (hybrid) -->
    <section class="panel">
      <h3>Visuals</h3>
      <div id="charts" class="charts-grid"></div>
      <p id="chartNote" class="muted" style="display:none;">
        Showing auto‑generated visuals from extracted numbers.
      </p>
    </section>

    <section class="panel">
      <h3>Source Slides</h3>
      <div id="refs" class="ref-list"></div>
      <p class="muted">Click any source to open the original report at the cited slide/page.</p>
    </section>
  </div>

  <script>
    // --- Helpers -------------------------------------------------------------

    // Remove only the OUTER wrapping quotes if present; keep periods.
    function cleanQuoteText(txt) {
      if (!txt) return "";
      // Trim whitespace, then strip a single pair of leading/trailing quotes (straight or curly)
      const cleaned = String(txt).trim().replace(/^["“]+/, "").replace(/["”]+$/, "");
      // Ensure there is a trailing period if the original had one; otherwise keep as-is.
      return cleaned;
    }

    // Create a Google Slides deep-link if we have slideIndex; otherwise return fileUrl
    function slideLink(fileUrl, slideIndex) {
      if (!fileUrl) return "#";
      // If it already has params, just append slide index as best-effort
      if (typeof slideIndex === "number") {
        const hasQuery = fileUrl.includes("?");
        return fileUrl + (hasQuery ? "&" : "?") + "slide=" + (slideIndex + 1); // humans count from 1
      }
      return fileUrl;
    }

    function el(tag, attrs = {}, children = []) {
      const node = document.createElement(tag);
      for (const [k, v] of Object.entries(attrs)) {
        if (k === "class") node.className = v;
        else if (k === "html") node.innerHTML = v;
        else node.setAttribute(k, v);
      }
      for (const c of [].concat(children)) {
        if (typeof c === "string") node.appendChild(document.createTextNode(c));
        else if (c) node.appendChild(c);
      }
      return node;
    }

    // --- Rendering logic -----------------------------------------------------

    function renderAnswer(text) {
      const box = document.getElementById("answer");
      box.textContent = text || "No answer.";
      box.style.display = "block";
    }

    function renderBullets(items = []) {
      const ul = document.getElementById("bullets");
      ul.innerHTML = "";
      items.forEach(x => {
        // Ensure NO trailing period for bullets (your preference)
        let t = String(x || "").trim();
        t = t.replace(/[.。]\s*$/, ""); // drop final period if present
        ul.appendChild(el("li", {}, t));
      });
    }

    function renderQuotes(items = []) {
      const ul = document.getElementById("quotes");
      ul.innerHTML = "";
      items.forEach(q => {
        // remove extra wrapping quotes, but DO NOT remove periods
        const cleaned = cleanQuoteText(q);
        ul.appendChild(el("li", {}, cleaned));
      });
    }

    // Draw up to N charts from numeric series (if available)
    function renderCharts(visuals = [], maxCharts = 3) {
      const grid = document.getElementById("charts");
      const note = document.getElementById("chartNote");
      grid.innerHTML = "";
      let drawn = 0;

      visuals.slice(0, maxCharts).forEach(series => {
        // expected shape example:
        // { title: "Evrysdi Satisfaction", type:"line",
        //   points:[{x:"2023", y:79}, {x:"2024", y:83}] }
        if (!series || !Array.isArray(series.points) || series.points.length < 2) return;

        const card = el("div", { class: "chart-card" });
        card.appendChild(el("h4", {}, series.title || "Chart"));
        const canvas = el("canvas");
        card.appendChild(canvas);
        grid.appendChild(card);

        const labels = series.points.map(p => p.x);
        const values = series.points.map(p => Number(p.y));

        new Chart(canvas.getContext("2d"), {
          type: (series.type === "bar" ? "bar" : "line"),
          data: {
            labels,
            datasets: [{ label: series.title || "", data: values }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { callback: v => v + "%" } } },
            plugins: { legend: { display: false } }
          }
        });
        card.style.height = "260px";
        drawn++;
      });

      note.style.display = drawn ? "block" : "none";
      if (!drawn) {
        grid.appendChild(el("div", { class: "muted" }, "No chartable data found for this answer."));
      }
    }

    function renderRefs(refs = []) {
      const list = document.getElementById("refs");
      list.innerHTML = "";
      if (!refs.length) {
        list.appendChild(el("div", { class: "muted" }, "No sources returned."));
        return;
      }

      refs.forEach(r => {
        // expected ref shape:
        // {
        //   fileName: "Final_2025 ... Readout.pptx",
        //   fileUrl: "https://docs.google.com/presentation/d/....",
        //   slideIndex: 11, // optional (0-based)
        //   page: 1,       // optional for PDFs
        //   snippet: "…"
        // }
        const title = r.fileName || "Report";
        const slideLabel =
          (typeof r.slideIndex === "number") ? `Slide ${r.slideIndex + 1}` :
          (typeof r.page === "number") ? `p.${r.page}` : "";
        const url = slideLink(r.fileUrl, r.slideIndex);

        const item = el("div", { class: "ref-item" }, [
          el("a", { href: url, target: "_blank", rel: "noopener" }, title),
          slideLabel ? el("div", { class: "muted" }, slideLabel) : null,
          r.snippet ? el("div", { class: "muted" }, r.snippet) : null
        ]);

        list.appendChild(item);
      });
    }

    // --- Demo fetch glue -----------------------------------------------------
    // Works with your existing /search endpoint. Adjust field names if yours differ.
    async function runQuery(userQuery) {
      const res = await fetch("/search", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-auth-token": (window.AUTH_TOKEN || "") // optional; your server may not require from browser
        },
        body: JSON.stringify({
          clientId: "genentech",
          userQuery,
          topK: 6
        })
      });

      if (!res.ok) throw new Error("Search failed: " + res.status);
      const data = await res.json();

      // Expected shape from your server (tolerant to missing fields):
      // {
      //   answer: "…",
      //   bullets: ["…","…"],
      //   quotes: ["“quoted sentence.”", "“another one.”"],
      //   visuals: [{ title, type, points:[{x,y},…] }, …],
      //   references: [{fileName, fileUrl, slideIndex?, page?, snippet?}, …]
      // }
      renderAnswer(data.answer || "No answer.");
      renderBullets(data.bullets || data.supporting || []);
      renderQuotes(data.quotes || []);
      renderCharts(data.visuals || []);
      renderRefs(data.references || []);
    }

    // Submit handler
    document.getElementById("qform").addEventListener("submit", async (e) => {
      e.preventDefault();
      const q = document.getElementById("q").value.trim();
      if (!q) return;
      try {
        await runQuery(q);
      } catch (err) {
        console.error(err);
        alert("Search error. See console for details.");
      }
    });

    // Auto-run once for the default field value (nice for demos)
    window.addEventListener("DOMContentLoaded", () => {
      const q = document.getElementById("q").value.trim();
      if (q) document.getElementById("qform").dispatchEvent(new Event("submit"));
    });
  </script>
</body>
</html>
