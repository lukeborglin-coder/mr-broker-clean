<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>COG gpt — Research Q&A</title>

  <style>
    :root {
      --bg: #f6f7f9;
      --panel: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --accent: #ff7a00;
      --ring: #d1d5db;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink);
      background: var(--bg);
    }
    .page { max-width: 1100px; margin: 24px auto 56px; padding: 0 16px; position: relative; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 18px; margin-bottom: 10px; }
    header .logo { font-weight: 800; font-size: 28px; letter-spacing: 0.5px; }
    header .logo .dot { color: var(--accent); }
    header .beta { color: #9ca3af; font-weight: 700; letter-spacing: .02em; }

    .searchbar {
      display: grid; grid-template-columns: 1fr auto; gap: 12px;
      background: var(--panel); padding: 16px; border-radius: 12px; border: 1px solid var(--ring);
      position: sticky; top: 0; z-index: 1;
    }
    textarea {
      width: 100%; min-height: 52px; resize: vertical; padding: 12px 14px; font-size: 15px; line-height: 1.4;
      border: 1px solid var(--ring); border-radius: 10px; outline: none; background: #fff;
    }
    button.ask {
      padding: 12px 18px; border-radius: 10px; border: 1px solid var(--ring);
      background: var(--accent); color: #fff; font-weight: 700; cursor: pointer;
    }
    button.ask:disabled { opacity: .6; cursor: not-allowed; }

    .section { background: var(--panel); border: 1px solid var(--ring); border-radius: 12px; padding: 16px; margin-top: 16px; }
    .section h3 { margin: 0 0 8px; font-size: 16px; color: var(--muted); text-transform: uppercase; letter-spacing: .02em; }
    .answer { border-left: 4px solid var(--accent); background: #fff7ef; }
    .answer p { margin: 0; }
    ul { margin: 8px 0 0 18px; }
    li { margin: 6px 0; }
    .tiny { color: var(--muted); font-size: 12px; }

    .mode-toggle { display: flex; gap: 8px; margin-bottom: 10px; }
    .mode-toggle button {
      border: 1px solid var(--ring); background: #fff; padding: 8px 12px; border-radius: 999px; cursor: pointer;
    }
    .mode-toggle button.active { background: #111827; color: #fff; border-color: #111827; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .ref-card, .chart-card, .table-card {
      border: 1px solid var(--ring); border-radius: 10px; padding: 12px; background: #fff;
    }
    .ref-title { font-weight: 600; }
    .superscript { vertical-align: super; font-size: 0.75em; }

    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
  </style>

  <!-- Chart.js for Charts mode -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="page">
    <header>
      <div class="logo">COG<span class="dot">gpt</span></div>
      <div class="beta">(BETA)</div>
    </header>

    <!-- Search -->
    <div class="searchbar">
      <textarea id="q" placeholder="ask anything about your research (e.g., “What is Evrysdi’s trending satisfaction?”)"></textarea>
      <button id="ask" class="ask">Ask</button>
    </div>

    <!-- Results (all hidden until a question is asked and a response arrives) -->
    <section class="section answer" id="answerBox" style="display:none">
      <p id="answerText"></p>
    </section>

    <section class="section" id="detailBox" style="display:none">
      <h3>Supporting Detail</h3>
      <ul id="detailList"></ul>
    </section>

    <section class="section" id="quotesBox" style="display:none">
      <h3>Supporting Quotes</h3>
      <ul id="quotesList"></ul>
      <div class="tiny" id="quotesFoot"></div>
    </section>

    <section class="section" id="slidesBox" style="display:none">
      <div class="mode-toggle">
        <button id="modeCharts" class="active" data-mode="charts">Charts</button>
        <button id="modeRefs" data-mode="references">References</button>
      </div>
      <div id="slidesBody"></div>
    </section>

    <section class="section" id="refsBox" style="display:none">
      <h3>References</h3>
      <ol id="refsList"></ol>
    </section>

    <p class="tiny" style="margin-top:10px">
      Tip: if your server requires a token, open DevTools Console and run:
      <code>localStorage.setItem('AUTH_TOKEN','YOUR_TOKEN_HERE')</code> then refresh.
    </p>
  </div>

  <script>
    // ===== Utilities =====
    const AUTH_TOKEN = localStorage.getItem('AUTH_TOKEN') || '';
    const $  = (sel) => document.querySelector(sel);
    const show = (sel, yes) => { const el = $(sel); if (!el) return; el.style.display = yes ? '' : 'none'; };

    // Remove outer wrapping quotes but keep punctuation
    function cleanQuote(text) {
      if (!text) return '';
      let s = String(text).trim();
      if ((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))) {
        s = s.slice(1, -1).trim();
      }
      return s;
    }

    function extractPercents(text) {
      if (!text) return [];
      const re = /(\d{1,3})\s*%/g;
      const out = []; let m;
      while ((m = re.exec(text)) !== null) {
        const n = Number(m[1]);
        if (n >= 0 && n <= 100) out.push(n);
      }
      return out;
    }

    function makeLineChart(canvas, label, arr) {
      const ctx = canvas.getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: arr.map((_, i) => `T${i+1}`),
          datasets: [{ label, data: arr, tension: 0.25, pointRadius: 3 }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { y: { suggestedMin: 0, suggestedMax: 100, ticks: { callback: v => v + '%' } } }
        }
      });
    }

    function liRef(ref) {
      const slideMatch = String(ref?.title || ref?.name || ref).match(/\b(p\.?\s?\d+|slide\s*\d+)\b/i);
      const slideHint = slideMatch ? ` — ${slideMatch[0]}` : '';
      const text = (ref && (ref.title || ref.name)) ? (ref.title || ref.name) : (typeof ref === 'string' ? ref : 'Untitled');
      return `<li><span class="ref-title">${text}</span>${slideHint}</li>`;
    }

    // ===== Rendering =====
    function renderAll(payload) {
      const { answer, bullets = [], quotes = [], references = [] } = payload || {};

      const hasAny = Boolean(answer) || bullets.length || quotes.length || references.length;

      // Answer box (always show something after a query)
      $('#answerText').textContent = answer || 'I don’t have enough information.';
      show('#answerBox', true);

      // Details
      const detailHTML = (bullets || []).map(b => `<li>${String(b).replace(/\.\s*$/,'')}.</li>`).join('');
      $('#detailList').innerHTML = detailHTML;
      show('#detailBox', bullets.length > 0);

      // Quotes (strip outer quotes, keep periods)
      const quoteHTML = (quotes || []).map(q => {
        let s = cleanQuote(q);
        if (!/[.!?]$/.test(s) && /[.!?]$/.test(String(q).trim())) s = s + '.';
        return `<li><strong>${s}</strong> <span class="superscript">⁴</span></li>`;
      }).join('');
      $('#quotesList').innerHTML = quoteHTML;
      $('#quotesFoot').textContent = quotes.length ? 'Outer quotes removed; sentence punctuation preserved.' : '';
      show('#quotesBox', quotes.length > 0);

      // References (bottom list)
      $('#refsList').innerHTML = (references || []).map(liRef).join('');
      show('#refsBox', references.length > 0);

      // Slides section: only show after a query, and only if we can display *either* chart data or references
      const allText = [answer, ...(bullets || [])].join(' | ');
      const percents = extractPercents(allText);
      const canChart = percents.length >= 1;
      const canRefs = (references || []).length > 0;
      show('#slidesBox', canChart || canRefs);

      if (canChart || canRefs) renderSlidesMode(canChart ? 'charts' : 'references', payload);
    }

    function renderSlidesMode(mode, payload) {
      const { answer = '', bullets = [], references = [] } = payload || {};
      $('#modeCharts').classList.toggle('active', mode === 'charts');
      $('#modeRefs').classList.toggle('active', mode === 'references');

      const host = $('#slidesBody');
      host.innerHTML = '';

      if (mode === 'references') {
        const box = document.createElement('div'); box.className = 'grid';
        (references || []).forEach(ref => {
          const card = document.createElement('div');
          card.className = 'ref-card';
          card.innerHTML = `<div class="ref-title">${(ref?.title || ref?.name || 'Untitled')}</div>
                            <div class="tiny">${ref?.fileName || ''}</div>`;
          box.appendChild(card);
        });
        host.appendChild(box);
        return;
      }

      // Charts
      const allText = [answer, ...bullets].join(' | ');
      const percents = extractPercents(allText);

      const visualsWrap = document.createElement('div'); visualsWrap.className = 'grid';

      // Trend line if ≥2 points
      if (percents.length >= 2) {
        const card = document.createElement('div');
        card.className = 'chart-card';
        card.innerHTML = `<canvas id="trendChart" height="170"></canvas>
                          <div class="tiny" style="margin-top:6px">Auto-derived from numeric values detected in answer/details.</div>`;
        visualsWrap.appendChild(card);
        setTimeout(() => makeLineChart($('#trendChart'), 'Trend', percents.slice(-5)), 0);
      }

      // Key Metrics table
      const tableCard = document.createElement('div'); tableCard.className = 'table-card';
      const labels = ['Metric 1', 'Metric 2', 'Metric 3', 'Metric 4'];
      const rows = percents.slice(0, 4).map((p, i) => `<tr><td>${labels[i]}</td><td style="text-align:right">${p}%</td></tr>`);
      tableCard.innerHTML = `
        <div style="font-weight:600;margin-bottom:6px">Key Metrics</div>
        <table style="width:100%; border-collapse:collapse">
          <tbody>
            ${rows.length ? rows.join('') : `<tr><td class="tiny">No numeric metrics detected in text.</td></tr>`}
          </tbody>
        </table>
        <div class="tiny" style="margin-top:6px">Numbers parsed from current answer/details text.</div>
      `;
      visualsWrap.appendChild(tableCard);

      host.appendChild(visualsWrap);
    }

    // ===== Events / Search =====
    $('#modeCharts').addEventListener('click', () => renderSlidesMode('charts', window.__lastPayload || {}));
    $('#modeRefs').addEventListener('click', () => renderSlidesMode('references', window.__lastPayload || {}));

    function hideAllResults() {
      ['#answerBox','#detailBox','#quotesBox','#slidesBox','#refsBox'].forEach(sel => show(sel, false));
    }
    hideAllResults(); // start with a clean page

    async function doAsk() {
      const btn = $('#ask');
      const q = $('#q').value.trim();
      if (!q) return;

      btn.disabled = true; btn.textContent = 'Thinking…';
      hideAllResults();

      try {
        const resp = await fetch('/search', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(AUTH_TOKEN ? { 'x-auth-token': AUTH_TOKEN } : {})
          },
          body: JSON.stringify({ clientId: 'genentech', userQuery: q, topK: 6 })
        });

        // Handle non-200s with a friendly error box
        if (!resp.ok) {
          const text = await resp.text().catch(() => '');
          $('#answerText').textContent = `Request failed (${resp.status}). ${text || 'Check server logs and token.'}`;
          show('#answerBox', true);
          return;
        }

        const data = await resp.json();

        // Normalize shapes your server might return
        const normalized = {
          answer: data.answer || data.summary || '',
          bullets: data.details || data.bullets || [],
          quotes: data.quotes || [],
          references: data.references || data.sources || [],
          visuals: data.visuals || {}
        };

        window.__lastPayload = normalized;
        renderAll(normalized);
      } catch (e) {
        $('#answerText').textContent = `Search error: ${e?.message || e}`;
        show('#answerBox', true);
        console.error(e);
      } finally {
        btn.disabled = false; btn.textContent = 'Ask';
      }
    }

    $('#ask').addEventListener('click', doAsk);
    $('#q').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey || !e.shiftKey)) {
        e.preventDefault();
        doAsk();
      }
    });
  </script>
</body>
</html>
