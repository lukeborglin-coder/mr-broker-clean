<!DOCTYPE html>

<html lang="en">
<head>
<link href="/favicon.ico" rel="icon" type="image/x-icon"/>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Jaice â€” Research Q&amp;A</title>
<link href="/styles.css" rel="stylesheet"/>
<style>
    :root {
      --jaice-orange: #ff7a00;
      --text-primary: #1c1d1f;
      --text-muted: #666;
      --logo-grey: #6b7280;
      --background: #ffffff;
      --border: #e0e4e7;
      --white: #fff;
      --shadow-soft: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-medium: 0 4px 12px rgba(0,0,0,0.15);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      overflow-x: hidden;
    }

    /* SIMPLIFIED LAYOUT - NO SIDEBAR */
    .app-layout {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: white;
    }

    /* NEW HEADER DESIGN - Full width with centered navigation */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: white;
      border-bottom: 1px solid var(--border);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      box-shadow: var(--shadow-soft);
    }

    /* Logo on left */
    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: var(--text-primary);
      flex-shrink: 0;
    }

    .logo img {
      height: 32px;
      width: auto;
    }

    .beta-badge {
      background: transparent;
      border: 1px solid #9ca3af;
      color: #6b7280;
      font-size: 8px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      box-shadow: none;
    }

    /* CENTERED NAVIGATION */
    .main-nav {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 40px;
    }

    .nav-link {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 500;
      font-size: 16px;
      border-radius: 8px;
      transition: all 0.2s ease;
      position: relative;
    }

    .nav-link:hover {
      background: #f8f9fa;
      color: var(--jaice-orange);
    }

    .nav-link.active {
      color: var(--jaice-orange);
      font-weight: 600;
    }

    .nav-link.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 20px;
      right: 20px;
      height: 2px;
      background: var(--jaice-orange);
      border-radius: 1px;
    }

    /* Right side - user info and profile */
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
      z-index: 1001;
      flex-shrink: 0;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .profile {
      position: relative;
      z-index: 1002;
    }

    .profile-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--white);
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s ease;
    }

    .profile-btn:hover {
      background: #f8f9fa;
      border-color: var(--jaice-orange);
    }

    .profile-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-medium);
      min-width: 180px;
      z-index: 1003;
      display: none;
      overflow: hidden;
    }

    .profile-menu.show {
      display: block;
    }

    .profile-menu a,
    .profile-menu button {
      display: block;
      width: 100%;
      padding: 12px 16px;
      text-align: left;
      background: none;
      border: none;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .profile-menu a:hover,
    .profile-menu button:hover {
      background: #f8f9fa;
    }

    .company-name {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    /* Client Selector */
    .client-selector-corner {
      position: fixed;
      top: 80px;
      right: 32px;
      z-index: 999;
      display: none;
    }

    .client-selector-corner.show {
      display: block;
    }

    .client-selector-corner select {
      padding: 10px 32px 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--white);
      font-size: 14px;
      min-width: 220px;
      box-shadow: var(--shadow-soft);
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 8px center;
      background-repeat: no-repeat;
      background-size: 16px;
      transition: all 0.2s ease;
    }

    .client-selector-corner select:focus {
      outline: none;
      border-color: var(--jaice-orange);
      box-shadow: 0 0 0 3px rgba(255, 122, 0, 0.1);
    }

    /* MAIN CONTENT - No sidebar, full width */
    .main-content {
      flex: 1;
      margin-top: 70px;
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 70px);
      background: white;
    }

    .content {
      flex: 1;
      padding: 0 32px;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
    }

    .content.initial-state {
      justify-content: flex-start;
      align-items: center;
      text-align: center;
      padding-top: calc(25vh - 70px);
    }

    .content.results-state {
      justify-content: flex-start;
      padding-top: 40px;
      text-align: left;
    }
          
    .content.results-state .hero { 
      display:flex; 
      flex-direction:column; 
      align-items:center; 
      text-align:center; 
    }
    .content.results-state .hero h1,
    .content.results-state .hero p { 
      margin-left:auto; 
      margin-right:auto; 
    }

    /* HERO SECTION */
    .hero {
      margin-bottom: 32px;
    }

    .hero h1 {
      font-size: clamp(28px, 5vw, 42px);
      font-weight: 700;
      margin: 0 0 12px;
      color: var(--logo-grey);
      letter-spacing: -0.025em;
      line-height: 1.1;
    }

    .hero h1 .highlight {
      color: var(--jaice-orange);
    }

    .hero p {
      font-size: 18px;
      color: var(--text-muted);
      margin: 0 auto 24px;
      max-width: 600px;
      line-height: 1.5;
    }

    /* SEARCH SECTION */
    .search-section {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto 8px auto;
      padding: 0 0px;
    }

    .search-container {
      position: relative;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 32px;
    }

    .search-input-wrapper {
      position: relative;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: var(--shadow-soft);
      transition: all 0.2s ease;
      min-height: 52px;
      display: flex;
      align-items: center;
      padding: 8px 12px;
    }

    .search-input-wrapper:focus-within {
      border-color: var(--jaice-orange);
      box-shadow: 0 0 0 3px rgba(255, 122, 0, 0.1), var(--shadow-soft);
    }

    .search-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 16px;
      background: transparent;
      color: var(--text-primary);
      padding: 8px 12px;
      resize: none;
      min-height: 20px;
      max-height: 120px;
      line-height: 1.5;
      font-family: inherit;
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .filter-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s ease;
    }

    .filter-btn:hover {
      background: #f8f9fa;
      color: var(--jaice-orange);
    }

    .search-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: none;
      background: var(--jaice-orange);
      border-radius: 8px;
      cursor: pointer;
      color: var(--white);
      transition: all 0.2s ease;
      position: relative;
    }

    .search-btn:hover:not(:disabled) {
      background: #e86900;
      transform: scale(1.05);
    }

    .search-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .search-btn:disabled .search-arrow {
      display: none;
    }

    .search-btn .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }

    .search-btn.loading .spinner {
      display: block;
    }

    .search-btn.loading .search-arrow {
      display: none;
    }

    .search-arrow {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .disclaimer {
      color: var(--text-muted);
      font-size: 12px;
      margin: 6px auto 0;
      font-style: italic;
      opacity: 0.8;
      text-align: center;
      max-width: 1400px;
    }

    /* RESULTS AREA */
    .results-area {
      display: none;
      animation: slideInFromBottom 0.6s ease forwards;
      margin-top: 32px;
    }

    @keyframes slideInFromBottom {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .results-area.clearing {
      opacity: 0.3;
      transition: opacity 0.3s ease;
    }

    .answer-card {
      background: #fff7ed;
      border: 1px solid #fed7aa;
      border-left: 4px solid var(--jaice-orange);
      border-radius: 16px;
      padding: 24px 60px 24px 24px;
      margin-bottom: 32px;
      position: relative;
      box-shadow: var(--shadow-soft);
      display: none;
    }

    .refresh-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #fed7aa;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 11px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s ease;
    }

    .refresh-btn:hover {
      background: #fff;
      color: var(--jaice-orange);
    }

    .answer-headline {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .answer-divider {
      height: 1px;
      background: #fed7aa;
      margin: 12px 0;
    }

    .answer-details {
      font-size: 15px;
      line-height: 1.6;
      color: var(--text-primary);
    }

    /* DASHBOARD */
    .dashboard {
      margin-bottom: 32px;
    }

    .dashboard-flow {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .dashboard-item {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-soft);
      transition: all 0.2s ease;
    }

    .dashboard-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .dashboard-item.wide-chart {
      width: 100%;
    }

    .dashboard-item.wide-chart .chart-container {
      height: 300px;
      margin: 16px 0;
    }

    .dashboard-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .dashboard-item.single {
      grid-column: span 1;
    }

    .dashboard-item h4 {
      margin: 0 0 8px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--jaice-orange);
      padding-bottom: 12px;
      padding-right: 40px;
    }

    .chart-description {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.4;
      margin-bottom: 16px;
      text-align: left;
    }

    .chart-content {
      margin-top: 16px;
    }

    .bullets {
      margin: 16px 0;
      padding-left: 20px;
    }

    .bullets li {
      margin-bottom: 8px;
      line-height: 1.5;
      color: var(--text-primary);
    }

    .quote-section {
      margin: 16px 0;
    }

    .quote-item {
      margin: 12px 0;
      padding: 16px;
      background: #f8f9fa;
      border-left: 3px solid var(--jaice-orange);
      border-radius: 4px;
      font-style: italic;
      color: #666;
    }

    .quote-text {
      margin-bottom: 8px;
      font-size: 15px;
      line-height: 1.5;
      font-style: italic;
    }

    .quote-speaker {
      text-align: right;
      font-size: 12px;
      color: #999;
      font-weight: 500;
      font-style: normal;
    }

    sup {
      font-size: 0.7em;
      color: var(--jaice-orange);
      font-weight: 600;
      line-height: 0;
    }

    .hidden {
      display: none !important;
    }

    .report-slides-section {
      margin-top: 32px;
    }

    .report-slides-grid {
      display: flex;
      gap: 20px;
      margin-top: 16px;
      overflow: hidden;
      scroll-behavior: smooth;
      padding-bottom: 10px;
      position: relative;
    }

    .report-slides-container {
      position: relative;
    }

    .report-slides-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      right: -20px;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--border);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      box-shadow: var(--shadow-soft);
      transition: all 0.2s ease;
    }

    .report-slides-nav:hover {
      background: var(--jaice-orange);
      color: white;
    }

    .report-slides-nav svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .report-slide-card {
      cursor: pointer;
      flex: 0 0 calc(33.333% - 14px);
      min-width: 320px;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .report-slide-preview {
      height: 220px !important;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      transition: all 0.2s ease;
    }

    .report-slide-preview:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-medium);
    }

    .report-slide-content {
      padding: 0 !important;
      text-align: left;
    }

    .report-slide-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      line-height: 1.2;
    }

    .report-slide-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.3;
    }

    @media (min-width: 1200px) {
      .report-slide-card {
        flex: 0 0 calc(25% - 15px);
        min-width: 340px;
      }
    }

    .report-slide-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-medium);
    }

    /* Prevent hover effects on the text content under images */
    .report-slide-content {
      pointer-events: none;
    }
    
    /* Re-enable pointer events for the image part */
    .report-slide-preview {
      pointer-events: auto;
    }

    /* Three-dot menu styles */
    .card-header-with-menu {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      position: relative;
    }
    
    .dropdown-container {
      position: absolute;
      top: 0;
      right: 0;
      z-index: 10;
    }
    
    .three-dot-menu {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      opacity: 0.6;
      transition: opacity 0.2s ease, background-color 0.2s ease;
    }
    
    .three-dot-menu:hover {
      opacity: 1;
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    .three-dot-menu .dot {
      width: 3px;
      height: 3px;
      background-color: #666;
      border-radius: 50%;
    }
    
    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      min-width: 160px;
      z-index: 1000;
      padding: 4px 0;
    }
    
    .dropdown-menu.show {
      display: block;
    }
    
    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 8px 12px;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: background-color 0.2s ease;
    }
    
    .dropdown-item:hover {
      background-color: #f3f4f6;
    }
    
    .dropdown-icon {
      font-size: 14px;
    }

    /* Modal styles for enlarged PDF view */
    .pdf-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .pdf-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .pdf-modal-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .pdf-modal-image {
      width: 100%;
      height: auto;
      max-height: 85vh;
      object-fit: contain;
      display: block;
    }

    .pdf-modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
      z-index: 10000;
    }

    .pdf-modal-close:hover {
      background: rgba(0, 0, 0, 0.9);
    }

    .pdf-modal-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
      color: white;
      padding: 20px;
      font-size: 14px;
    }

    .report-slide-preview {
      aspect-ratio: 16/9;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-bottom: 1px solid var(--border);
      overflow: hidden;
    }
    
    .slide-preview-fallback {
      width: 90%;
      height: 85%;
      background: #ffffff;
      border: 1px solid #e1e5e9;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .slide-content {
      width: 85%;
      height: 80%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    
    .slide-header {
      width: 70%;
      height: 8px;
      background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
      border-radius: 2px;
    }
    
    .slide-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .slide-text-lines {
      width: 100%;
    }
    
    .slide-line {
      height: 3px;
      background: #e5e7eb;
      border-radius: 2px;
      margin: 4px 0;
    }
    
    .slide-line.short {
      width: 60%;
    }
    
    .slide-footer {
      font-size: 8px;
      color: #6b7280;
      text-align: center;
      font-weight: 500;
    }
    
    .slide-overlay {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
      z-index: 2;
    }
    
    .slide-page-number {
      color: white;
    }

    .report-slide-content {
      padding: 16px;
    }

    .report-slide-title {
      font-weight: 600;
      font-size: 15px;
      line-height: 1.3;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .report-slide-subtitle {
      color: var(--text-muted);
      font-size: 13px;
      line-height: 1.2;
    }

    .no-preview {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted, #6b7280);
      font-size: 12px;
      background: rgba(0,0,0,0.02);
      border-radius: 10px;
      display: none;
    }
    
    .report-slide-preview.broken .no-preview {
      display: flex;
    }
    
    .report-slide-preview.broken img {
      display: none !important;
    }
    
    .report-slide-preview img {
      image-rendering: auto;
    }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
      .main-nav {
        display: none;
      }
      
      .content {
        padding: 16px;
      }
      
      .content.initial-state {
        padding-top: calc(20vh - 70px);
      }
      
      .client-selector-corner {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 16px;
      }
      
      .dashboard-row {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .report-slides-grid {
        gap: 16px;
      }
      
      .report-slide-card {
        flex: 0 0 260px;
        min-width: 260px;
      }
    }

    @media (max-width: 768px) {
      .header {
        padding: 0 16px;
      }
      
      .hero h1 {
        font-size: 24px;
      }
      
      .search-input-wrapper {
        min-height: 48px;
      }
      
      .dashboard-item {
        padding: 16px;
      }
      
      .answer-card {
        padding: 16px 40px 16px 16px;
      }
    }
  </style>
<link href="enhanced_chart_css.css" rel="stylesheet"/>
<link href="/modern-bridge.css" rel="stylesheet">
<script>
function monthToNum(m){
  if(!m) return 0;
  const map={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
  const s=String(m).toLowerCase().slice(0,3);
  return map[s]||0;
}
function sortRefsByRecency(refs){
  try{
    return (refs||[]).slice().sort((a,b)=>{
      const ya=Number(a.yearTag||a.year||0), yb=Number(b.yearTag||b.year||0);
      if(yb!==ya) return yb-ya;
      const ma=monthToNum(a.monthTag||a.month), mb=monthToNum(b.monthTag||b.month);
      return mb-ma;
    });
  }catch(e){ return refs||[]; }
}
</script>
</link></head>
<body>
<!-- Fixed Header with Centered Navigation -->
<header class="header">
<!-- Logo on Left -->
<div style="display: flex; align-items: center; gap: 12px;">
<a class="logo" href="/">
<img alt="Jaice" src="/assets/Slide1.JPG"/>
</a>
<span class="beta-badge">BETA</span>
</div>
<!-- Centered Navigation -->
<nav class="main-nav">
<a class="nav-link active" href="/">Home</a>
<a class="nav-link" href="/reports.html">Reports</a>
<a class="nav-link" href="/admin" id="adminNavLink" style="display: none;">Admin</a>
</nav>
<!-- Right Side - User Info & Profile -->
<div class="header-right">
<div class="user-info">
<span id="userDisplay">Loading...</span>
</div>
<div class="company-name" id="companyNameDisplay" style="display: none;">GENENTECH</div>
<div class="profile">
<button class="profile-btn" id="profileBtn">
<svg fill="currentColor" height="16" viewbox="0 0 24 24" width="16">
<path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"></path>
</svg>
</button>
<div class="profile-menu" id="profileMenu">
<a href="/admin" id="adminCenterLink" style="display: none;">Admin Center</a>
<button id="logoutBtn" type="button">Sign Out</button>
</div>
</div>
</div>
</header>
<!-- Client Selector -->
<div class="client-selector-corner" id="clientSelectorCorner">
<select id="clientSelect">
<option value="">Select a client library</option>
</select>
</div>
<div class="app-layout">
<!-- Main Content (No Sidebar) -->
<main class="main-content">
<div class="content initial-state" id="contentArea">
<!-- Hero Section -->
<section class="hero">
<h1>ASK ABOUT YOUR RESEARCH<span class="highlight">.</span></h1>
<p>Search across your uploaded reports, questionnaires, and data.</p>
</section>
<!-- Search Section -->
<section class="search-section">
<div class="search-container">
<div class="search-input-wrapper">
<textarea class="search-input" id="searchInput" maxlength="500" placeholder="Ask a question about your research..." rows="1"></textarea>
<div class="search-controls">
<button class="filter-btn" id="filterBtn" title="Filters">
<svg fill="currentColor" height="16" viewbox="0 0 24 24" width="16">
<path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"></path>
</svg>
</button>
<button class="search-btn" id="searchBtn">
<svg class="search-arrow" fill="currentColor" height="16" viewbox="0 0 24 24" width="16">
<path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
</svg>
<div class="spinner"></div>
</button>
</div>
</div>
</div>
<div class="disclaimer">
            JAICE can make mistakes. Check important info.
          </div>
</section>
<!-- Results Area -->
<div class="results-area" id="resultsArea" style="display: none;">
<!-- Answer Card -->
<div class="answer-card" id="answerCard" style="display: none;">
<div class="card-header-with-menu">
<div class="answer-headline" id="answerHeadline"></div>
<div class="dropdown-container">
<button class="three-dot-menu" onclick="showSaveMenu(this, 'answer')" aria-label="Options">
<span class="dot"></span>
<span class="dot"></span>
<span class="dot"></span>
</button>
<div class="dropdown-menu">
<button onclick="saveToReport('answer')" class="dropdown-item">
<span class="dropdown-icon">ðŸ“„</span>
Save to Report
</button>
<button onclick="exportContent('answer')" class="dropdown-item">
<span class="dropdown-icon">ðŸ“¤</span>
Export
</button>
</div>
</div>
</div>
<div class="answer-divider"></div>
<div class="answer-details" id="answerDetails"></div>
</div>
<!-- Dynamic Dashboard Section -->
<div class="dashboard" id="dashboard" style="display: none;">
<div class="dashboard-flow" id="dashboardFlow">
<!-- Dashboard items will be populated here with dynamic layout -->
</div>
</div>
</div>
</div>
<section class="dash-grid" id="dash-root" style="margin:24px 0;"></section>
</main>
</div>

<!-- PDF Modal -->
<div id="pdfModal" class="pdf-modal">
  <div class="pdf-modal-content">
    <button class="pdf-modal-close" id="pdfModalClose">&times;</button>
    <img id="pdfModalImage" class="pdf-modal-image" src="" alt="">
    <div class="pdf-modal-info" id="pdfModalInfo"></div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
    // PDF Modal functions
    function openPdfModal(fileId, page, fileName) {
      const modal = document.getElementById('pdfModal');
      const image = document.getElementById('pdfModalImage');
      const info = document.getElementById('pdfModalInfo');
      
      // Set image source and info
      image.src = `/secure-slide/${fileId}/${page}`;
      image.alt = `${fileName || 'Report'} - Slide ${page}`;
      info.innerHTML = `<strong>${fileName || 'Report'}</strong><br>Slide ${page}`;
      
      // Show modal
      modal.classList.add('active');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closePdfModal() {
      const modal = document.getElementById('pdfModal');
      modal.classList.remove('active');
      document.body.style.overflow = ''; // Restore scrolling
    }

    // Initialize modal event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('pdfModal');
      const closeBtn = document.getElementById('pdfModalClose');
      
      // Close on X button click
      closeBtn.addEventListener('click', closePdfModal);
      
      // Close on background click
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closePdfModal();
        }
      });
      
      // Close on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          closePdfModal();
        }
      });
    });

    // Global state
    let currentUser = null;
    let currentClient = null;
    let currentReferences = [];

    // Global chart instances tracker
    window.chartInstances = window.chartInstances || new Map();

    // FIXED: Enhanced clear function that destroys all chart instances
    function clearAllCharts() {
      console.log('ðŸ§¹ Clearing all chart instances...');
      
      if (window.chartInstances) {
        window.chartInstances.forEach((chart, containerId) => {
          try {
            chart.destroy();
            console.log('Destroyed chart:', containerId);
          } catch (e) {
            console.warn('Error destroying chart:', containerId, e);
          }
        });
        window.chartInstances.clear();
      }
      
      // Also remove any remaining canvas elements
      document.querySelectorAll('canvas[id$="_canvas"]').forEach(function(canvas) {
        try {
          canvas.remove();
        } catch (e) {
          console.warn('Error removing canvas:', e);
        }
      });
      
      console.log('âœ… All charts cleared');
    }

    // Helper function to remove existing sections
    function removeExistingSections() {
      const existingSlides = document.getElementById('reportSlides');
      const existingReports = document.getElementById('reportsReferenced');
      
      if (existingSlides) {
        existingSlides.querySelectorAll('[id^="chart-"]').forEach(chartContainer => {
          const chartId = chartContainer.id;
          if (window.chartInstances && window.chartInstances.has(chartId)) {
            try {
              window.chartInstances.get(chartId).destroy();
              window.chartInstances.delete(chartId);
            } catch (e) {
              console.warn('Error destroying chart in slides section:', e);
            }
          }
        });
        existingSlides.remove();
      }
      
      if (existingReports) {
        existingReports.remove();
      }
    }

    // Chart rendering function
    function renderChart(containerId, chartData) {
      const container = document.getElementById(containerId);
      if (!container) {
        console.warn('Chart container not found:', containerId);
        return;
      }
      
      if (window.chartInstances.has(containerId)) {
        const existingChart = window.chartInstances.get(containerId);
        try {
          existingChart.destroy();
          console.log('Destroyed existing chart:', containerId);
        } catch (e) {
          console.warn('Error destroying chart:', e);
        }
        window.chartInstances.delete(containerId);
      }
      
      container.innerHTML = '';
      
      console.log('Rendering chart:', containerId, chartData);
      
      if (window.Chart && chartData && chartData.series && chartData.series.length > 0) {
        const canvas = document.createElement('canvas');
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        canvas.id = containerId + '_canvas';
        container.appendChild(canvas);
        
        const labels = chartData.series.map(s => s.label);
        const data = chartData.series.map(s => s.value);
        
        // Determine chart type intelligently
        let chartType = 'bar'; // Default to bar charts
        
        // Only use pie charts for market share data that adds up to ~100%
        const total = data.reduce((sum, val) => sum + val, 0);
        if (chartData.type === 'pie' && total >= 90 && total <= 110) {
          chartType = 'pie';
        } else if (chartData.type === 'line') {
          chartType = 'line';
        }
        
        // Enhanced color selection with brand color matching
        let backgroundColor, borderColor;
        if (chartType === 'pie') {
          backgroundColor = labels.map(function(label) {
            const lowerLabel = label.toLowerCase();
            if (lowerLabel.includes('evrysdi') || lowerLabel.includes('risdiplam')) return '#4472C4';
            if (lowerLabel.includes('spinraza') || lowerLabel.includes('nusinersen')) return '#ED7D31';
            if (lowerLabel.includes('zolgensma') || lowerLabel.includes('onasemnogene')) return '#7030A0';
            if (lowerLabel.includes('untreated') || lowerLabel.includes('no treatment')) return '#94a3b8';
            if (lowerLabel.includes('other') || lowerLabel.includes('others')) return '#777777';
            
            const index = labels.indexOf(label);
            const orangeShades = ['#4472C4', '#ED7D31', '#7030A0', '#94a3b8', '#777777', '#A5A5A5', '#FFC000', '#5B9BD5'];
            return orangeShades[index % orangeShades.length];
          });
          borderColor = '#fff';
        } else {
          backgroundColor = labels.map(function(_, i) { return 'rgba(68, 114, 196, ' + (0.8 - i * 0.1) + ')'; });
          borderColor = labels.map(function(_, i) { return 'rgba(68, 114, 196, 1)'; });
        }
        
        const chartConfig = {
          type: chartType,
          data: {
            labels: labels,
            datasets: [{
              label: '',
              data: data,
              backgroundColor: backgroundColor,
              borderColor: borderColor,
              borderWidth: chartType === 'pie' ? 2 : 1,
              fill: chartType === 'line' ? false : true
            }]
          },
          plugins: [ChartDataLabels],
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: chartType === 'pie',
                position: 'right',
                labels: {
                  font: { size: 12 },
                  padding: 15,
                  usePointStyle: true
                }
              },
              title: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.parsed || context.parsed === 0 ? context.parsed : context.raw;
                    return context.label + ': ' + value + '%';
                  }
                }
              },
              datalabels: {
                display: true,
                color: chartType === 'pie' ? '#fff' : '#333',
                font: { weight: 'bold', size: 14 },
                formatter: function(value, context) {
                  return value + '%';
                },
                anchor: chartType === 'pie' ? 'center' : 'end',
                align: chartType === 'pie' ? 'center' : 'top',
                offset: chartType === 'pie' ? 0 : -8,
                clip: false
              }
            },
            scales: chartType === 'pie' ? {} : {
              y: {
                display: false,
                grid: { display: false },
                border: { display: false }
              },
              x: {
                grid: { display: false },
                border: { display: false },
                ticks: { maxRotation: 45, font: { size: 11 } }
              }
            }
          }
        };
        
        Chart.register(ChartDataLabels);
        const chartInstance = new Chart(canvas.getContext('2d'), chartConfig);
        window.chartInstances.set(containerId, chartInstance);
      } else if (chartData && chartData.series) {
        const ul = document.createElement('ul');
        ul.style.margin = '16px 0';
        ul.style.paddingLeft = '0';
        ul.style.listStyle = 'none';
        
        chartData.series.forEach((item, index) => {
          const li = document.createElement('li');
          li.style.margin = '8px 0';
          li.style.padding = '12px 16px';
          li.style.background = `rgba(255, 122, 0, ${0.1 + (index * 0.1)})`;
          li.style.borderRadius = '8px';
          li.style.borderLeft = '4px solid #ff7a00';
          li.style.display = 'flex';
          li.style.justifyContent = 'space-between';
          li.style.alignItems = 'center';
          
          li.innerHTML = 
            '<span style="font-weight: 600;">' + item.label + '</span>' +
            '<span style="background: #4472C4; color: white; padding: 6px 12px; border-radius: 16px; font-size: 14px; font-weight: bold;">' +
              item.value + '%' +
            '</span>';
          ul.appendChild(li);
        });
        
        container.appendChild(ul);
      } else {
        console.warn('No valid chart data available for', containerId);
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No chart data available</p>';
      }
    }

    // Helper functions
    function formatRefsToSup(text) {
      const s = String(text || "");
      return s
        .replace(/\s?\[(\d+(?:\s*,\s*\d+)*)\]/g, (_, m) => `<sup>${m.replace(/\s+/g, '')}</sup>`)
        .replace(/\((\d+(?:\s*,\s*\d+)*)\)/g, (_, m) => `<sup>${m.replace(/\s+/g, '')}</sup>`)
        .replace(/\[ref(\d+)\]/gi, '<sup>$1</sup>');
    }

    function switchToResultsLayout() {
      const contentArea = document.getElementById('contentArea');
      contentArea.classList.remove('initial-state');
      contentArea.classList.add('results-state');
      
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    // Hardened init: sends cookies, robust /me handling, admin-only gate on /admin
    async function initializeApp() {
      try {
        const response = await fetch('/me', {
          credentials: 'include',           // ensure session cookie is sent
          cache: 'no-store',
          headers: { 'Accept': 'application/json' }
        });

        if (response.status === 401) {
          window.location.href = '/login.html';
          return;
        }
        if (!response.ok) {
          console.error('Init /me failed', response.status, await response.text().catch(()=>'')); 
          window.location.href = '/login.html';
          return;
        }

        const payload = await response.json();
        const user = payload && payload.user ? payload.user : null;
        const activeClientId = payload && 'activeClientId' in payload ? payload.activeClientId : null;

        if (!user || !user.role) {
          console.error('Malformed /me payload:', payload);
          window.location.href = '/login.html';
          return;
        }

        // Admin-only guard when on the admin page
        const onAdminPage = location.pathname.startsWith('/admin') || document.body.dataset.page === 'admin';
        if (onAdminPage) {
          const role = String(user.role).toLowerCase().trim();
          if (role !== 'admin') {
            window.location.href = '/';
            return;
          }
        }

        // set globals
        currentUser = user;
        currentClient = activeClientId || null;

        // init UI
        if (typeof updateUserDisplay === 'function') updateUserDisplay();
        if (typeof loadClientLibraries === 'function') await loadClientLibraries();
        if (typeof setupEventListeners === 'function') setupEventListeners();

      } catch (error) {
        console.error('Failed to initialize app:', error);
        window.location.href = '/login.html';
      }
    }

    function updateUserDisplay() {
      const userDisplay = document.getElementById('userDisplay');
      const companyNameDisplay = document.getElementById('companyNameDisplay');
      const adminCenterLink = document.getElementById('adminCenterLink');
      const adminNavLink = document.getElementById('adminNavLink');
      const clientSelectorCorner = document.getElementById('clientSelectorCorner');
      
      if (currentUser) {
        const roleDisplay = currentUser.role === 'admin' ? 'admin' : currentUser.role;
        userDisplay.textContent = `${currentUser.username} (${roleDisplay})`;
        
        if (currentUser.role === 'admin') {
          if (adminCenterLink) adminCenterLink.style.display = 'block';
          if (adminNavLink) adminNavLink.style.display = 'block';
          if (clientSelectorCorner) clientSelectorCorner.classList.add('show');
          if (companyNameDisplay) companyNameDisplay.style.display = 'none';
        } else {
          if (companyNameDisplay) {
            companyNameDisplay.style.display = 'block';
            companyNameDisplay.textContent = 'GENENTECH';
          }
          if (clientSelectorCorner) clientSelectorCorner.classList.remove('show');
          if (adminCenterLink) adminCenterLink.style.display = 'none';
          if (adminNavLink) adminNavLink.style.display = 'none';
        }
      }
    }

    async function loadClientLibraries() {
      try {
        const response = await fetch('/api/client-libraries');
        if (response.ok) {
          const libraries = await response.json();
          
          const clientSelect = document.getElementById('clientSelect');
          clientSelect.innerHTML = '<option value="">Select a client library</option>';
          
          libraries.forEach(function(lib) {
            const option = document.createElement('option');
            option.value = lib.id;
            option.textContent = lib.name;
            clientSelect.appendChild(option);
          });
          
          if (currentClient) {
            clientSelect.value = currentClient;
          }
        }
      } catch (error) {
        console.warn('Failed to load client libraries:', error);
      }
    }

    function setupEventListeners() {
      // Profile menu
      const profileBtn = document.getElementById('profileBtn');
      const profileMenu = document.getElementById('profileMenu');
      
      profileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        profileMenu.classList.toggle('show');
      });
      
      document.addEventListener('click', () => {
        profileMenu.classList.remove('show');
      });

      // Search functionality
      const searchBtn = document.getElementById('searchBtn');
      const searchInput = document.getElementById('searchInput');
      
      searchBtn.addEventListener('click', performSearch);
      
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          performSearch();
        }
      });

      const clientSelect = document.getElementById('clientSelect');
      clientSelect.addEventListener('change', async (e) => {
        const selectedClientId = e.target.value;
        if (selectedClientId) {
          currentClient = selectedClientId;
        }
      });

      const logoutBtn = document.getElementById('logoutBtn');
      logoutBtn.addEventListener('click', async () => {
        try {
          await fetch('/auth/logout', { method: 'POST' });
          window.location.href = '/login.html';
        } catch (error) {
          window.location.href = '/login.html';
        }
      });
    }

    async function performSearch(refresh = false) {
      const query = document.getElementById('searchInput').value.trim();
      
      if (!query) {
        return;
      }

      if (currentUser?.role === 'admin' && !currentClient) {
        alert('Please select a client library first');
        return;
      }

      if (!refresh) {
        clearPreviousResults();
      }

      const searchBtn = document.getElementById('searchBtn');
      searchBtn.disabled = true;
      searchBtn.classList.add('loading');

      try {
        const requestBody = {
          userQuery: query,
          generateSupport: true
        };

        if (currentUser?.role === 'admin' && currentClient) {
          requestBody.clientId = currentClient;
        }

        if (refresh) {
          requestBody.refresh = Date.now();
        }

        const response = await fetch('/search', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Search failed');
        }

        const results = await response.json();
        
        window.lastSearchResponse = results; // Store for report slides access
        switchToResultsLayout();
        displayResults(results);

      } catch (error) {
        console.error('Search failed:', error);
        alert(error.message || 'Search failed. Please try again.');
      } finally {
        searchBtn.disabled = false;
        searchBtn.classList.remove('loading');
      }
    }

    function determineLayoutClass(theme, index) {
      const hasChart = theme.chartData && theme.chartData.series && theme.chartData.series.length > 0;
      
      if (!hasChart) {
        return 'single';
      }
      
      const chartType = theme.chartData.type;
      const dataPointCount = theme.chartData.series.length;
      
      const needsFullWidth = (
        (chartType === 'bar' && dataPointCount >= 5) ||
        (chartType === 'line') ||
        (index === 0 && chartType === 'bar')
      );
      
      return needsFullWidth ? 'wide-chart' : 'single';
    }

    function createDashboardItem(theme, layoutClass = '', index = 0) {
      const item = document.createElement('div');
      item.className = `dashboard-item ${layoutClass}`;
      
      const bullets = Array.isArray(theme.bullets) ? 
        Array.from(new Set(theme.bullets)).map(function(b) { return '<li>' + formatRefsToSup(b) + '</li>'; }).join('') : '';
      
      const validQuotes = Array.isArray(theme.quotes) ? 
        theme.quotes.filter(function(q) { return q && (q.text || typeof q === 'string'); }).slice(0, 2) : [];
      
      const quotes = validQuotes.map(function(q) {
        const text = q.text || q;
        const speaker = q.speaker || 'Source';
        return '<div class="quote-item">' +
            '<div class="quote-text">"' + formatRefsToSup(text) + '"</div>' +
            '<div class="quote-speaker">â€” ' + speaker + '</div>' +
          '</div>';
      }).join('');

      let chartHtml = '';
      if (theme.chartData && Array.isArray(theme.chartData.series) && theme.chartData.series.length > 0) {
        const chartId = 'chart-' + Date.now() + '-' + index + '-' + Math.random().toString(36).substr(2, 9);
        const containerClass = layoutClass === 'wide-chart' ? 'chart-container' : '';
        const chartHeight = layoutClass === 'wide-chart' ? '300px' : '220px';
        
        const chartTitle = theme.chartData.title || theme.title;
        
        chartHtml = 
          '<div class="chart-wrapper ' + containerClass + '" style="margin: 16px 0; background: #f8f9fa; border-radius: 8px; padding: 16px; height: ' + chartHeight + ';">' +
            '<h5 style="margin: 0 0 12px 0; color: #333; font-size: 14px; font-weight: 600; text-align: center;">' + chartTitle + '</h5>' +
            '<div id="' + chartId + '" style="position: relative; height: calc(100% - 32px); min-height: 160px;"></div>' +
          '</div>';
        
        setTimeout(() => {
          try {
            renderChart(chartId, theme.chartData);
          } catch (error) {
            console.error('Chart rendering failed:', error);
            const container = document.getElementById(chartId);
            if (container) {
              container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">Chart temporarily unavailable</p>';
            }
          }
        }, 200 + (index * 50));
      }
      
      item.innerHTML = 
        '<h4>' + (theme.title || 'Supporting Finding') + '</h4>' +
        (theme.subtitle ? '<p class="chart-description">' + theme.subtitle + '</p>' : '') +
        '<div class="chart-content">' +
          chartHtml +
          (bullets ? '<ul class="bullets">' + bullets + '</ul>' : '') +
          (quotes ? '<div class="quote-section">' + quotes + '</div>' : '') +
        '</div>';
      
      return item;
    }

    // Enhanced displayReportSlides function with content page resolution
    async function resolveToContentPage(fileId, page) {
      const searchRange = [page, page + 1, page - 1, page + 2, page - 2, page + 3, page - 3];
      const dividerPattern = /(detailed findings|executive summary|appendix|agenda|section|table of contents|contents|toc|overview|methodology|disclaimer|thank you|cover|divider|q\s*&\s*a|q&a)/i;
      
      for (const p of searchRange) {
        if (p <= 1) continue;
        
        try {
          const response = await fetch(`/secure-slide/text/${fileId}/${p}`);
          if (!response.ok) continue;
          
          const data = await response.json();
          if (!data.ok) continue;
          
          // Content must have digits or % and not match divider keywords
          const hasNumbers = data.hasDigits || data.hasPercent;
          const isDivider = dividerPattern.test(data.snippet || '');
          
          if (hasNumbers && !isDivider) {
            return p;
          }
        } catch (e) {
          console.warn(`Failed to check page ${p} for ${fileId}:`, e);
          continue;
        }
      }
      
      // If no content page found, skip this slide entirely
      return null;
    }

    function displayReportSlides() {
      const dashboard = document.getElementById('dashboard');

      // Remove previous section if present
      const prev = document.getElementById('reportSlides');
      if (prev) prev.remove();

      const section = document.createElement('div');
      section.id = 'reportSlides';
      section.className = 'report-slides-section';
      section.innerHTML = `
        <h3 style="margin-bottom:16px;color:var(--text-primary);font-size:18px;font-weight:600;">Related Report Slides</h3>
        <div class="report-slides-container">
          <button class="report-slides-nav report-slides-prev" id="reportSlidesPrev" style="display: none; left: -20px;">
            <svg viewBox="0 0 24 24">
              <path d="M14.71 6.71c-.39-.39-1.02-.39-1.41 0L8.71 11.3c-.39.39-.39 1.02 0 1.41l4.59 4.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L10.83 12l3.88-3.88c.39-.39.39-1.02 0-1.41z"/>
            </svg>
          </button>
          <div class="report-slides-grid" id="reportSlidesGrid"></div>
          <button class="report-slides-nav report-slides-next" id="reportSlidesNext" style="display: none;">
            <svg viewBox="0 0 24 24">
              <path d="M9.29 6.71c-.39.39-.39 1.02 0 1.41L13.17 12l-3.88 3.88c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l4.59-4.59c.39-.39.39-1.02 0-1.41L10.7 6.7c-.38-.38-1.02-.38-1.41.01z"/>
            </svg>
          </button>
        </div>
      `;
      dashboard.after(section);

      // Get citations from current references or search response
      const citations = window.currentReferences || 
        (window.lastSearchResponse && window.lastSearchResponse.references && window.lastSearchResponse.references.chunks) || 
        [];

      if (!citations || citations.length === 0) {
        const grid = document.getElementById('reportSlidesGrid');
        grid.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:40px;">No report slides available for this search.</p>';
        return;
      }

      // Extract fileId and page from citations
      const slidePromises = citations.slice(0, 12).map(async (citation) => {
        const fileId = citation.fileId || citation.driveId || citation.gdocId;
        const page = citation.page || citation.pageNumber || citation.pageIndex || 1;
        
        if (!fileId) return null;
        
        // Resolve to nearest content page
        const contentPage = await resolveToContentPage(fileId, page);
        if (!contentPage) return null;
        
        return {
          fileId: fileId,
          page: contentPage,
          source: citation.fileName || citation.source || 'Unknown Report',
          date: (citation.monthTag ? (citation.monthTag + ' ') : '') + (citation.yearTag || 'Unknown Date')
        };
      });

      // Wait for all slide resolutions
      Promise.all(slidePromises).then(resolvedSlides => {
        const validSlides = resolvedSlides.filter(Boolean);

        // De-duplicate by fileId + page combination
        const seen = new Set();
        const uniqueSlides = validSlides.filter(slide => {
          const key = `${slide.fileId}-${slide.page}`;
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        }).slice(0, 6);

        const grid = document.getElementById('reportSlidesGrid');
        const nextBtn = document.getElementById('reportSlidesNext');
        
        if (!uniqueSlides.length) {
          grid.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:40px;">No content slides found for this search.</p>';
          nextBtn.style.display = 'none';
          return;
        }

        const prevBtn = document.getElementById('reportSlidesPrev');
        
        // Show/hide navigation buttons based on slide count
        if (uniqueSlides.length > 3) {
          let currentIndex = 0;
          const maxIndex = Math.max(0, uniqueSlides.length - 3);
          
          function updateButtons() {
            prevBtn.style.display = currentIndex > 0 ? 'flex' : 'none';
            nextBtn.style.display = currentIndex < maxIndex ? 'flex' : 'none';
          }
          
          nextBtn.addEventListener('click', () => {
            if (currentIndex < maxIndex) {
              currentIndex++;
              const scrollAmount = currentIndex * (340 + 20); // card width + gap
              grid.scrollTo({ left: scrollAmount, behavior: 'smooth' });
              updateButtons();
            }
          });
          
          prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
              currentIndex--;
              const scrollAmount = currentIndex * (340 + 20); // card width + gap
              grid.scrollTo({ left: scrollAmount, behavior: 'smooth' });
              updateButtons();
            }
          });
          
          updateButtons(); // Initial button state
        } else {
          nextBtn.style.display = 'none';
          prevBtn.style.display = 'none';
        }

        const stripExt = (s) => String(s||'').replace(/\.[^/.]+$/,'');

        const io = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (!entry.isIntersecting) return;
            const card = entry.target;
            const img = card.querySelector('img.slide-img');
            const loader = card.querySelector('.slide-loading');
            const frame = card.querySelector('.report-slide-preview');
            if (img && img.dataset.src && !img.src) {
              loader.style.display = 'flex';
              img.src = img.dataset.src;
              img.onload = () => { img.style.display='block'; loader.style.display='none'; };
              img.onerror = () => { loader.style.display='none'; frame.classList.add('broken'); };
            }
            io.unobserve(card);
          });
        }, { rootMargin: '200px 0px' });

        uniqueSlides.forEach((slide) => {
          const safeTitle = stripExt(slide.source || 'Unknown Report');
          const safeDate = slide.date || 'Unknown Date';
          
          // Use resolved content page number
          const imgSrc = `/secure-slide/${encodeURIComponent(slide.fileId)}/${slide.page}`;

          const card = document.createElement('div');
          card.className = 'report-slide-card';

          card.innerHTML = `
            <div class="report-slide-preview" style="position:relative;">
              <div class="slide-loading" aria-hidden="true"><div class="spinner"></div></div>
              <div class="no-preview">No preview</div>
              <img class="slide-img" data-src="${imgSrc}" alt="Slide ${slide.page}" style="width:100%;height:100%;object-fit:cover;display:none;" />
            </div>
            <div class="report-slide-content">
              <div class="report-slide-title">${safeTitle}</div>
              <div class="report-slide-subtitle">
                ${safeDate} â€¢ Slide ${slide.page}
              </div>
            </div>
          `;

          // Add click handler for modal popup
          card.addEventListener('click', () => {
            const cleanFileName = (slide.fileName || slide.source || 'Report').replace(/\.[^/.]+$/, '');
            openPdfModal(slide.fileId, slide.page, cleanFileName);
          });

          grid.appendChild(card);
          io.observe(card);
        });

        try { console.log(`âœ… Display complete - ${uniqueSlides.length} content slides rendered`); } catch {}
      });
    }

    function displayReportsReferenced(references) {
      const reportSlidesSection = document.getElementById('reportSlides');
      
      const reportsSection = document.createElement('div');
      reportsSection.id = 'reportsReferenced';
      reportsSection.style.cssText = `
        margin-top: 40px;
        border-top: 2px solid var(--border);
        padding-top: 24px;
      `;
      
      reportsSection.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 12px 0; user-select: none;" onclick="toggleReportsReferenced()">
          <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: var(--text-primary);">Reports Referenced</h3>
          <span style="font-size: 16px; color: var(--text-muted);">â–¼</span>
        </div>
        <div id="reportsReferencedContent" style="max-height: 500px; overflow-y: auto; margin-top: 16px;">
          <!-- Report references will be populated here -->
        </div>
      `;
      
      reportSlidesSection.after(reportsSection);
      
      const content = document.getElementById('reportsReferencedContent');
      
      if (!references || !references.length) {
        content.innerHTML = '<p style="color: var(--text-muted);">No references found for this search.</p>';
        return;
      }

      // Filter and deduplicate references to show only current, valid files
      const validReferences = references
        .filter(function(ref) { return ref && ref.fileName && ref.fileId; }) // Only refs with valid file data
        .reduce(function(unique, ref) {
          // Deduplicate by fileName only (not fileName + page)
          const fileName = ref.fileName;
          if (!unique.some(function(existing) { 
            return existing.fileName === fileName; 
          })) {
            unique.push(ref);
          }
          return unique;
        }, [])
        .slice(0, 10); // Limit to 10 references

      if (validReferences.length === 0) {
        content.innerHTML = '<p style="color: var(--text-muted);">No valid references found for this search.</p>';
        return;
      }

      // Create a global report numbering map to ensure consistent numbering
      if (!window.reportNumberMap) {
        window.reportNumberMap = new Map();
      }

      validReferences.forEach(function(ref, index) {
        // Get or assign a consistent number for this report
        let reportNumber;
        if (window.reportNumberMap.has(ref.fileName)) {
          reportNumber = window.reportNumberMap.get(ref.fileName);
        } else {
          reportNumber = window.reportNumberMap.size + 1;
          window.reportNumberMap.set(ref.fileName, reportNumber);
        }
        const refDiv = document.createElement('div');
        refDiv.style.cssText = `
          background: var(--white);
          border: 1px solid var(--border);
          border-radius: 12px;
          padding: 16px;
          margin-bottom: 12px;
          display: flex;
          align-items: flex-start;
          gap: 12px;
        `;
        
        const pageDisplay = (ref.page && ref.page > 1) || (ref.pageNumber && ref.pageNumber > 1) 
          ? '<span><strong>Page:</strong> ' + (ref.page || ref.pageNumber) + '</span>' 
          : '';
        
        refDiv.innerHTML = 
          '<div style="background: var(--jaice-orange); color: white; font-size: 12px; font-weight: 700; padding: 6px 10px; border-radius: 50%; min-width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">' +
            reportNumber +
          '</div>' +
          '<div style="flex: 1;">' +
            '<div style="font-weight: 600; font-size: 15px; color: var(--text-primary); margin-bottom: 8px; line-height: 1.3;">' +
              (ref.fileName || ref.title || 'Reference Document').replace(/\.[^/.]+$/, '') +
            '</div>' +
            '<div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 13px; color: var(--text-muted);">' +'<span><strong>Year:</strong> ' + (ref.yearTag || '') + '</span>' +'<span><strong>Month:</strong> ' + (ref.monthTag || '') + '</span>' +'<span><strong>Methodology:</strong> ' + (ref.reportTag || '') + '</span>' +
            '</div>' +
          '</div>';
        
        content.appendChild(refDiv);
      });
    }

    function toggleReportsReferenced() {
      const content = document.getElementById('reportsReferencedContent');
      const toggle = document.querySelector('#reportsReferenced span');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = 'â–¼';
      } else {
        content.style.display = 'none'; 
        toggle.textContent = 'â–¶';
      }
    }

    function parseStructuredAnswer(answer) {
      const text = String(answer || '').trim();
      
      const headlineMatch = text.match(/HEADLINE:\s*(.+?)(?=\nDETAILS:|$)/s);
      const detailsMatch = text.match(/DETAILS:\s*(.+?)$/s);
      
      if (headlineMatch && detailsMatch) {
        return {
          headline: headlineMatch[1].trim(),
          details: detailsMatch[1].trim()
        };
      }
      
      const sentences = text.split(/(?<=[.!?])\s+/).filter(Boolean);
      const headline = sentences[0] || 'Key findings from your research library';
      const details = sentences.slice(1).join(' ').trim();
      
      return { headline, details };
    }

    function clearPreviousResults() {
      const resultsArea = document.getElementById('resultsArea');
      if (resultsArea) {
        resultsArea.classList.add('clearing');
        
        setTimeout(() => {
          const answerCard = document.getElementById('answerCard');
          const dashboard = document.getElementById('dashboard');
          const dashboardFlow = document.getElementById('dashboardFlow');
          
          if (answerCard) answerCard.style.display = 'none';
          if (dashboard) dashboard.style.display = 'none';
          if (dashboardFlow) dashboardFlow.innerHTML = '';
          
          removeExistingSections();
          
          resultsArea.classList.remove('clearing');
        }, 300);
      }
    }

    // Enhanced displayResults function to ensure proper data handling
    function displayResults(results) {
      const resultsArea = document.getElementById('resultsArea');
      const answerCard = document.getElementById('answerCard');
      const answerHeadline = document.getElementById('answerHeadline');
      const answerDetails = document.getElementById('answerDetails');
      const dashboard = document.getElementById('dashboard');

      resultsArea.style.display = 'block';

      // Store the complete response for thumbnail access
      window.lastSearchResponse = results;
      
      console.log('Debug - Full search results:', results);
      console.log('Debug - Reports in results:', results.reports);

      // Set references for backward compatibility
      currentReferences = [];
      if (results.references) {
        if (Array.isArray(results.references)) {
          currentReferences = results.references;
        } else if (results.references.chunks && Array.isArray(results.references.chunks)) {
          currentReferences = results.references.chunks;
        }
      }
      
      // CRITICAL: Use the reports array which contains thumbnails and correct filenames
      if (results.reports && Array.isArray(results.reports)) {
        console.log('âœ… Using reports data with thumbnails and correct filenames');
        console.log('Debug - Reports data:', results.reports);
        
        // Use reports for display purposes (they have thumbnails)
        // but keep references for other functionality
        window.reportsWithThumbnails = results.reports;
      }

      // Display main answer
      if (results.answer && results.answer.trim()) {
        const formattedAnswer = parseStructuredAnswer(results.answer);
        answerHeadline.innerHTML = formatRefsToSup(formattedAnswer.headline);
        answerDetails.innerHTML = formatRefsToSup(formattedAnswer.details);
        answerCard.style.display = 'block';
      } else {
        answerCard.style.display = 'none';
      }

      // Display dashboard themes
      const dashboardFlow = document.getElementById('dashboardFlow');
      dashboardFlow.innerHTML = '';
      
      const themes = Array.isArray(results.supportingThemes) ? results.supportingThemes : [];

      if (themes.length) {
        const uniqueThemes = themes.filter(function(theme, index, self) {
          return index === self.findIndex(function(t) { return t.title === theme.title; });
        });
        
        uniqueThemes.forEach(function(theme, index) {
          const layoutClass = determineLayoutClass(theme, index);
          const item = createDashboardItem(theme, layoutClass, index);
          
          if (layoutClass === 'wide-chart') {
            dashboardFlow.appendChild(item);
          } else {
            const lastChild = dashboardFlow.lastElementChild;
            if (!lastChild || !lastChild.classList.contains('dashboard-row') || lastChild.children.length >= 2) {
              const rowDiv = document.createElement('div');
              rowDiv.className = 'dashboard-row';
              rowDiv.appendChild(item);
              dashboardFlow.appendChild(rowDiv);
            } else {
              lastChild.appendChild(item);
            }
          }
        });
      }

      dashboard.style.display = 'block';
      
      // Clean up any existing sections before displaying new ones
      removeExistingSections();
      
      // Display report slides with thumbnails
      displayReportSlides();
      
      // Display references section
      displayReportsReferenced(currentReferences);
    }

    // Make functions globally accessible
    window.toggleReportsReferenced = toggleReportsReferenced;
    window.renderChart = renderChart;
    window.clearAllCharts = clearAllCharts;

    window.addEventListener('beforeunload', () => {
      clearAllCharts();
    });

    document.addEventListener('DOMContentLoaded', () => {
      initializeApp();
      const adminNavLink = document.getElementById('adminNavLink');
      if (adminNavLink) {
        adminNavLink.addEventListener('click', (e) => {
          // Force a hard nav to /admin and neutralize any SPA/global handlers
          e.preventDefault();
          e.stopPropagation();
          try { console.log('[NAV] Admin clicked â†’ /admin'); } catch {}
          window.location.assign('/admin');
        }, true); // capture phase to run before other click handlers
      }
    });
  </script><div data-related-slides="" id="related-slides-wrap"></div>
<script src="color_matching_system.js"></script>
<script src="enhanced_chart_rendering.js"></script>
<script>
function renderRelatedSlides(refs){
  const wrap = document.getElementById("related-slides-wrap") || document.querySelector("[data-related-slides]");
  if(!wrap) return;
  wrap.innerHTML = "";
  const list = document.createElement("div");
  list.className="grid grid-cols-2 gap-4";
  (refs||[]).forEach(ref=>{
    if(!ref.fileId) return;
    const pg = ref.page || ref.pageNumber || 1;
    const img = document.createElement("img");
    img.loading="lazy";
    img.alt = (ref.fileName||"slide")+" p"+pg;
    img.style.width="100%";
    img.style.borderRadius="8px";
    img.src = `/secure-slide/${ref.fileId}/${pg}`;
    const card=document.createElement("div");
    card.appendChild(img);
    list.appendChild(card);
  });
  if(list.children.length===0){
    wrap.textContent = "No content slides found for this search.";
  }else{
    wrap.appendChild(list);
  }
}
function onSearchResultsArrived(results){
  try{
    const refs = (results && results.references && results.references.chunks) ? results.references.chunks : [];
    const dedup = [];
    const seen = new Set();
    for(const r of refs){
      const key = r.fileId ? ('id:'+r.fileId) : ('fp:'+(r.fileName||'')+'-'+(r.page||1));
      if(seen.has(key)) continue;
      seen.add(key);
      dedup.push(r);
    }
    const sorted = sortRefsByRecency(dedup);
    window.currentReferences = sorted;
    // Try to render if container exists
    renderRelatedSlides(sorted.slice(0,8));
    // Also update any references list if there is a hook function
    if (typeof renderReferencesList==='function') renderReferencesList(sorted);
  }catch(e){ console.error('render results error', e); }
}
</script>
</body>
</html>