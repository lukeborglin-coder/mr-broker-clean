<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cognitive Consulting — Research Q&A</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    :root { --brand:#ef6c00; }
    .page { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
    .title { font-size: 28px; font-weight: 700; }
    .logo-small { height: 28px; opacity:.9 }
    .search { display:flex; gap:8px; align-items:center; }
    .search input { flex:1; padding:12px 14px; border:1px solid #e2e8f0; border-radius:10px; outline:none; }
    .search button { background:var(--brand); color:#fff; border:none; border-radius:10px; padding:10px 16px; cursor:pointer; font-weight:600; }
    .card { border:1px solid #e2e8f0; border-radius:12px; padding:14px 16px; margin-top:14px; }
    .card h3 { margin:0 0 6px 0; font-size:18px; }
    .muted { color:#6b7280; }
    .refs { display:flex; flex-direction:column; gap:6px; margin-top:8px; }
    .ref a { text-decoration:none; }
    .bullets { margin:8px 0 0 18px; }
    .visuals { display:grid; gap:10px; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); margin-top:8px; }
    .visual { border:1px solid #e5e7eb; border-radius:10px; padding:8px; }
    .visual img { width:100%; height:auto; border-radius:8px; display:block; }
    .small { font-size:12px; color:#6b7280; }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <h1 class="title">Research Q&amp;A</h1>
      <img src="/assets/Cog_OUTLOOK_SIG.png" alt="Cognitive Consulting" class="logo-small" />
    </header>

    <section class="card">
      <div class="search">
        <input id="q" placeholder="Ask a question about your research…" />
        <button id="ask">Ask</button>
      </div>
      <div id="status" class="small muted" style="margin-top:6px;"></div>
    </section>

    <section class="card">
      <h3>Key Findings</h3>
      <div id="answer" class="muted">Ask a question to see findings.</div>
    </section>

    <section class="card">
      <h3>Supporting Details</h3>
      <div id="visuals" class="visuals muted">No supporting visuals found.</div>
    </section>

    <section class="card">
      <h3>References</h3>
      <div id="refs" class="refs muted">No references detected.</div>
      <div id="sources" class="bullets small"></div>
    </section>
  </div>

  <script>
    const API_BASE = "https://mr-broker.onrender.com";
    const AUTH     = "Jrx4cukgLvuj5jFs4mU0U5ckL+UxHfkrL5pHY+xr5Hw=";
    const CLIENT   = "genentech";

    const elQ      = document.getElementById("q");
    const elAsk    = document.getElementById("ask");
    const elStatus = document.getElementById("status");
    const elAns    = document.getElementById("answer");
    const elVis    = document.getElementById("visuals");
    const elRefs   = document.getElementById("refs");
    const elSrcs   = document.getElementById("sources");

    function safeText(s) { return (s ?? "").toString().trim(); }

    function refDisplay(ref) {
      // Try common fields coming from the backend
      const title = ref?.title || ref?.name || ref?.fileName || ref?.docTitle || "Untitled";
      const url   = ref?.url   || ref?.link || ref?.fileUrl || "#";
      const where = ref?.page != null ? ` (p.${ref.page})` :
                   ref?.slide != null ? ` (slide ${ref.slide})` : "";
      return { title: safeText(title) + where, url };
    }

    function showAnswer(text) {
      const t = safeText(text);
      elAns.classList.remove("muted");
      elAns.textContent = t || "No findings.";
      if (!t) elAns.classList.add("muted");
    }

    function showVisuals(visuals) {
      elVis.innerHTML = "";
      if (!Array.isArray(visuals) || visuals.length === 0) {
        elVis.textContent = "No supporting visuals found.";
        elVis.classList.add("muted");
        return;
      }
      elVis.classList.remove("muted");
      visuals.forEach(v => {
        const url = v?.imageUrl || v?.thumbUrl || v?.url;
        const cap = v?.caption || v?.title || "";
        const div = document.createElement("div");
        div.className = "visual";
        if (url) {
          div.innerHTML = `<a href="${url}" target="_blank" rel="noopener">
              <img src="${url}" alt="">
            </a>
            <div class="small">${cap ? safeText(cap) : ""}</div>`;
        } else {
          div.innerHTML = `<div class="small">[image missing]</div>`;
        }
        elVis.appendChild(div);
      });
    }

    function showRefs(refs) {
      elRefs.innerHTML = "";
      elSrcs.innerHTML = "";
      if (!Array.isArray(refs) || refs.length === 0) {
        elRefs.textContent = "No references detected.";
        elRefs.classList.add("muted");
        return;
      }
      elRefs.classList.remove("muted");

      refs.forEach(ref => {
        const { title, url } = refDisplay(ref);
        const p = document.createElement("div");
        p.className = "ref";
        if (url && url !== "#") {
          p.innerHTML = `<a href="${url}" target="_blank" rel="noopener">${title}</a>`;
        } else {
          p.textContent = title;
        }
        elRefs.appendChild(p);
      });

      // Optional: show a bullet list of raw source items if provided
      // e.g., data.sources which may be strings or objects
    }

    async function askQuestion() {
      const userQuery = elQ.value.trim();
      if (!userQuery) return;
      elStatus.textContent = "Thinking…";
      elStatus.classList.remove("muted");
      elAns.textContent = "";
      elVis.textContent = "Loading visuals…";
      elRefs.textContent = "Loading references…";

      try {
        const res = await fetch(`${API_BASE}/search`, {
          method: "POST",
          headers: {
            "x-auth-token": AUTH,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ clientId: CLIENT, userQuery, topK: 6 })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Display
        showAnswer(data?.answer || data?.summary || "");
        showVisuals(data?.visuals || data?.charts || []);
        showRefs(data?.references || data?.refs || data?.sources || []);

        elStatus.textContent = "";
      } catch (err) {
        console.error(err);
        elStatus.textContent = "Error: " + (err.message || err);
        elAns.textContent = "Something went wrong.";
        elVis.textContent = "No supporting visuals found.";
        elRefs.textContent = "No references detected.";
        elAns.classList.add("muted");
        elVis.classList.add("muted");
        elRefs.classList.add("muted");
      }
    }

    elAsk.addEventListener("click", askQuestion);
    elQ.addEventListener("keydown", (e) => { if (e.key === "Enter") askQuestion(); });

    // Optional: preload a sample question
    // askQuestion();
  </script>
</body>
</html>
