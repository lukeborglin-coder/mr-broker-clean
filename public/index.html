<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>COGgpt â€” Research Q&A</title>
  <link rel="stylesheet" href="/styles.css"/>
  <style>
    :root { --brand:#ff7a00; --ink:#111; --muted:#5f6570; --line:#e9edf2; }
    *{box-sizing:border-box}
    body { margin:0; background:#fff; color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--line); }
    .bar { max-width:1080px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand { font-weight:800; letter-spacing:.1px; }
    .beta { font-size:.9rem; color:var(--muted); font-weight:500; margin-left:6px; }
    .nav { display:flex; align-items:center; gap:12px; }
    .muted { color:var(--muted); }
    main { max-width:960px; margin: 56px auto; padding: 0 16px; }
    .topline { display:flex; align-items:center; justify-content:flex-end; margin-bottom:10px; }
    select, button, input { font-size:1rem; }
    select, input { border:1px solid var(--line); background:#fff; color:var(--ink); border-radius:12px; padding:10px 12px; }
    button { border:0; border-radius:12px; background:var(--brand); color:#111; font-weight:800; padding:12px 16px; cursor:pointer; }
    .hero { text-align:center; margin: 32px 0 18px; }
    .hero h1 { font-size:34px; margin:0 0 6px 0; }
    .hero p { margin:0; color:var(--muted); }
    .askbox { display:flex; gap:12px; width:100%; margin:18px auto 0; }
    .askbox input { flex:1; padding:18px 20px; font-size:1.05rem; border-radius:18px; }
    .askbox button { padding:16px 22px; border-radius:18px; }
    .panel { margin-top:22px; border:1px solid var(--line); border-radius:14px; padding:14px; background:#fff; }
    .refs { display:grid; gap:10px; }
    .ref { border:1px solid var(--line); border-radius:12px; padding:10px; }
    a.link { color:#0b57d0; text-decoration:none; }
    .admin { text-decoration:none; color:var(--ink); padding:8px 10px; border:1px solid var(--line); border-radius:10px; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div>
        <span class="brand">COGgpt</span><span class="beta">(BETA)</span>
      </div>
      <div class="nav">
        <a id="adminLink" class="admin" href="/admin" style="display:none;">Admin</a>
        <div id="who" class="muted"></div>
        <button id="logoutBtn" title="Sign out">Sign out</button>
      </div>
    </div>
  </header>

  <main>
    <div class="topline" id="clientTopWrap" style="display:none">
      <label for="client" class="muted" style="margin-right:8px;">Client library</label>
      <select id="client"></select>
    </div>

    <div class="hero">
      <h1>Ask about your research</h1>
      <p class="muted">Search across your uploaded reports, questionnaires, and data.</p>
    </div>

    <div class="askbox">
      <input id="q" placeholder="e.g., What has satisfaction for Product X looked like over the past few years?"/>
      <button id="ask">Ask</button>
    </div>

    <div id="out" style="display:none;">
      <div class="panel">
        <div class="muted" style="margin-bottom:6px;">Answer</div>
        <div id="answer" style="white-space:pre-wrap; line-height:1.5;"></div>
      </div>
      <div class="panel">
        <div class="muted" style="margin-bottom:6px;">References</div>
        <div id="refs" class="refs"></div>
      </div>
    </div>
  </main>

<script>
async function jget(url){ const r = await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function jpost(url, body){ const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }

let me=null;
async function boot() {
  try {
    me = await jget('/me');
  } catch {
    location.href = '/login.html'; return;
  }
  const { user, activeClientId, clients } = me;
  document.getElementById('who').textContent = `${user.username} ${user.role==='internal'?'(internal)':''}`;
  if (user.role === 'internal') document.getElementById('adminLink').style.display = 'inline';

  const clientSel = document.getElementById('client');
  clientSel.innerHTML = clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  if (activeClientId) clientSel.value = activeClientId;

  if (user.role === 'internal') {
    document.getElementById('clientTopWrap').style.display = 'flex';
    clientSel.onchange = async () => { await jpost('/auth/switch-client', { clientId: clientSel.value }); };
  }
}
boot();

async function doAsk() {
  const q = document.getElementById('q').value.trim();
  if (!q) return;
  const body = { userQuery: q };
  if (me?.user?.role === 'internal') body.clientId = document.getElementById('client').value;

  const resp = await jpost('/search', body);
  document.getElementById('out').style.display = 'block';
  document.getElementById('answer').textContent = resp.answer || 'No answer';
  const refs = resp.references?.chunks || [];
  document.getElementById('refs').innerHTML = refs.map((r,i) => `
    <div class="ref">
      <div><strong>[${i+1}]</strong> ${r.study || r.fileName || ''} ${r.date||''}</div>
      <div class="muted" style="margin-top:4px">${r.textSnippet||''}</div>
      <div style="margin-top:6px">${r.fileUrl ? `<a class="link" href="${r.fileUrl}" target="_blank">Open source</a>`:''}</div>
    </div>`).join('');
}
document.getElementById('ask').onclick = doAsk;
document.getElementById('q').addEventListener('keypress', (e)=>{ if (e.key === 'Enter') doAsk(); });

document.getElementById('logoutBtn').onclick = async () => {
  await jpost('/auth/logout', {});
  location.href = '/login.html';
};
</script>
</body>
</html>
