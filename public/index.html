<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cognitive Consulting — Research Q&A</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="page">

    <!-- Header -->
    <header class="header">
      <h1 class="title">Research Q&amp;A</h1>
      <img src="/assets/Cog_OUTLOOK_SIG.png" alt="Cognitive Consulting" class="logo-small" />
    </header>

    <!-- Search -->
    <section class="card search-card">
      <div class="search-row">
        <input id="q" class="search-input" placeholder="Ask about your research, e.g., How has satisfaction for Product X changed over time?" />
        <button id="askBtn" class="btn ask">Ask</button>
      </div>
    </section>

    <!-- Results -->
    <div id="results" class="results">

      <section class="card">
        <h2 class="section-title">Key Findings</h2>
        <div id="keyFindingsEmpty" class="muted">Ask a question to see findings.</div>
        <ul id="keyFindings" class="bullets" hidden></ul>
        <div id="createReportWrap" class="mt" hidden>
          <button id="createReportBtn" class="btn dark">Create report</button>
        </div>
      </section>

      <section class="card">
        <h2 class="section-title">Supporting Details</h2>
        <div id="supportingEmpty" class="muted">No supporting visuals found.</div>
        <div id="supportingGrid" class="grid2" hidden></div>
      </section>

      <section class="card">
        <h2 class="section-title">References</h2>
        <div id="refsEmpty" class="muted">No references detected.</div>
        <div id="refsGrid" class="grid3" hidden></div>

        <div id="sourcesWrap" class="mt small" hidden>
          <div class="small-bold">Sources</div>
          <ul id="sourcesList" class="bullets-inline"></ul>
        </div>
      </section>

    </div>
  </div>

  <!-- Inline app script -->
  <script>
    // ------- CONFIG -------
    const API_BASE = ''; // same origin on mr-broker.onrender.com
    const AUTH_TOKEN = 'Jrx4cukgLvuj5jFs4mU0U5ckL+UxHfkrL5pHY+xr5Hw=';
    const CLIENT_ID = 'demo'; // must match what you used during ingest

    // ------- DOM helpers -------
    const el = id => document.getElementById(id);
    const show = (node, on=true) => node.hidden = !on;
    const setText = (node, text) => node.textContent = text;

    // ------- API -------
    async function runSearch(userQuery, topK=6) {
      const resp = await fetch(`${API_BASE}/search`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-auth-token': AUTH_TOKEN
        },
        body: JSON.stringify({ clientId: CLIENT_ID, userQuery, topK })
      });
      if (!resp.ok) {
        const t = await resp.text().catch(()=> '');
        throw new Error(`Search failed (${resp.status}): ${t || resp.statusText}`);
      }
      return resp.json();
    }

    // ------- Renderers -------
    function renderAnswer(answer) {
      const ul = el('keyFindings');
      ul.innerHTML = '';

      const text = (answer || '').trim();
      if (!text) {
        show(el('keyFindingsEmpty'), true);
        show(ul, false);
        return;
      }

      // Split into sentences for bullets (basic, but does the job)
      const points = text
        .replace(/\n+/g, ' ')
        .split(/(?<=[.?!])\s+(?=[A-Z0-9])/)
        .filter(Boolean)
        .slice(0, 6);

      points.forEach(p => {
        const li = document.createElement('li');
        li.textContent = p;
        ul.appendChild(li);
      });

      show(el('keyFindingsEmpty'), false);
      show(ul, true);
    }

    function renderSources(sources) {
      const wrap = el('sourcesWrap');
      const list = el('sourcesList');
      const refsEmpty = el('refsEmpty');

      list.innerHTML = '';

      const items = Array.isArray(sources) ? sources : [];
      if (items.length === 0) {
        show(refsEmpty, true);
        show(wrap, false);
        return;
      }

      items.forEach(s => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        const name = s.fileName || 'Untitled';
        const study = s.study || 'N/A';
        const date = s.date || 'n/a';
        a.href = s.fileUrl || '#';
        a.target = '_blank';
        a.rel = 'noopener';
        a.textContent = `${name} — ${study} (${date})`;
        li.appendChild(a);
        list.appendChild(li);
      });

      show(refsEmpty, false);
      show(wrap, true);
    }

    function clearSupporting() {
      // Placeholder (wire up charts/thumbnails later)
      show(el('supportingEmpty'), true);
      show(el('supportingGrid'), false);
      el('supportingGrid').innerHTML = '';
    }

    // ------- Events -------
    async function onAsk() {
      const q = el('q').value.trim();
      if (!q) return;
      setText(el('keyFindingsEmpty'), 'Thinking…');
      show(el('keyFindingsEmpty'), true);
      show(el('keyFindings'), false);
      clearSupporting();
      show(el('sourcesWrap'), false);

      try {
        const data = await runSearch(q);
        renderAnswer(data.answer);
        renderSources(data.sources);
      } catch (err) {
        setText(el('keyFindingsEmpty'), err.message || 'Something went wrong.');
        show(el('keyFindingsEmpty'), true);
        show(el('keyFindings'), false);
        show(el('sourcesWrap'), false);
      }
    }

    el('askBtn').addEventListener('click', onAsk);
    el('q').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') onAsk();
    });
  </script>
</body>
</html>
