<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Research Q&A</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="page">

    <!-- Header -->
    <header class="header">
      <h1 class="title">
        <span class="title-cog">Research Q&amp;A</span>
        <span class="beta-badge">(BETA)</span>
      </h1>
      <div class="header-actions">
        <a class="cg-btn" href="/admin.html">Admin</a>
        <button class="cg-btn" id="signOutBtn" type="button">Sign out</button>
      </div>
    </header>

    <!-- Hero / Instructions with darker left accent -->
    <section class="callout cg-dark-accent">
      <div class="muted">Secure area</div>
      <h3 style="margin:6px 0 8px 0;">Ask a question grounded in your LIBRARY</h3>
      <p class="muted">Enter a clear question. We’ll return key findings, citations, and related slides when available.</p>
    </section>

    <!-- Search -->
    <section class="search">
      <div class="panel">
        <div style="display:grid; grid-template-columns: 1fr; gap:12px;">
          <div>
            <label class="label" for="clientLibrary">Client Library</label>
            <select id="clientLibrary" class="select">
              <option value="" disabled selected>Select...</option>
            </select>
          </div>

          <form id="qform" autocomplete="off">
            <textarea id="q" class="textarea" placeholder="e.g., What has satisfaction for Product X looked like over the past few years?"></textarea>
            <button class="btn-ask" type="submit">Ask</button>
          </form>

          <div id="inlineErr" class="muted hidden"></div>
        </div>
      </div>
    </section>

    <!-- Results (hidden until a question is asked) -->
    <section id="results" class="results hidden">
      <div class="panel">
        <h3>Answer</h3>
        <div id="answer"></div>
      </div>

      <div class="panel">
        <h3>References</h3>
        <ol id="references" class="ref-ol"></ol>
      </div>

      <div class="panel">
        <h3>Report Slides</h3>
        <div id="slides" class="charts-grid"></div>
      </div>
    </section>

  </div>

  <!-- Simple password gate (client-side) -->
  <div id="cgGate" class="cg-gate" role="dialog" aria-modal="true">
    <div class="cg-panel">
      <h3>Enter Access Password</h3>
      <p class="muted">This page is gated. Contact your admin if you don’t have access.</p>
      <form id="cgGateForm" autocomplete="off">
        <!-- dummy fields to discourage autofill -->
        <input type="text" class="hidden" aria-hidden="true">
        <input type="password" class="hidden" aria-hidden="true">

        <label class="cg-label" for="cgGatePwd">Password</label>
        <input id="cgGatePwd" class="input cg-readonly" type="password" autocomplete="new-password" placeholder="Password" />

        <button class="cg-btn block" type="submit" style="margin-top:12px;">Continue</button>
        <div class="cg-hint">Tip: UI gate only. Enforce real auth in <code>server.js</code>.</div>
      </form>
    </div>
  </div>

  <script>
    // Helpers
    const $ = (sel) => document.querySelector(sel);

    // ----- Password gate (session-only)
    const GATE_KEY = "cg_gate_ok_v1";
    const gate = $("#cgGate");
    function gateOk() { return sessionStorage.getItem(GATE_KEY) === "1"; }
    function markGateOk() { sessionStorage.setItem(GATE_KEY, "1"); }
    function showGate() { gate.classList.add("open"); }
    function hideGate() { gate.classList.remove("open"); }

    (function setupGate() {
      const pwd = $("#cgGatePwd");
      // defeat aggressive autofill UX
      pwd.setAttribute("readonly", "readonly");
      pwd.addEventListener("focus", () => pwd.removeAttribute("readonly"), { once: true });

      $("#cgGateForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const val = pwd.value.trim();
        if (val === "coggpt25") { markGateOk(); hideGate(); }
        else alert("Incorrect password");
      });
      if (!gateOk()) showGate();
      $("#signOutBtn")?.addEventListener("click", () => { sessionStorage.removeItem(GATE_KEY); showGate(); });
    })();

    // ----- Populate Client Libraries (optional; best-effort)
    (async function loadLibraries() {
      const sel = $("#clientLibrary");
      const endpoints = ["/clients", "/admin/clients", "/api/clients"];
      for (const ep of endpoints) {
        try {
          const r = await fetch(ep);
          if (r.ok) {
            const data = await r.json();
            if (Array.isArray(data)) {
              for (const name of data) {
                const opt = document.createElement("option");
                opt.value = name; opt.textContent = name;
                sel.appendChild(opt);
              }
              break;
            }
          }
        } catch (_) { /* ignore */ }
      }
    })();

    // ----- Ask flow
    $("#qform").addEventListener("submit", async (e) => {
      e.preventDefault();
      const lib = $("#clientLibrary").value;
      const q = $("#q").value.trim();
      const err = $("#inlineErr");
      err.classList.add("hidden");
      if (!lib) { err.textContent = "Please select a Client Library."; err.classList.remove("hidden"); return; }
      if (!q) { err.textContent = "Please enter a question."; err.classList.remove("hidden"); return; }

      $("#results").classList.remove("hidden");
      $("#answer").textContent = "Thinking…";
      $("#references").innerHTML = "";
      $("#slides").innerHTML = "";

      try {
        const r = await fetch("/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ clientId: lib, userQuery: q, topK: 6 })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || "Search failed");

        $("#answer").textContent = data?.answer || "No answer.";
        const refs = data?.references || {};
        const visuals = data?.visuals || [];

        // references list (italic like your style)
        const items = Object.entries(refs).map(([k, v]) => `<li class="ref-li"><em>${k}</em> — ${v}</li>`).join("");
        $("#references").innerHTML = items || "<li class='ref-li'><em>No references</em></li>";

        // slides grid (limit 6)
        const max = 6;
        const imgs = visuals.slice(0, max)
          .map(src => `<img class="preview-img" src="${src}" alt="slide" />`)
          .join("");
        $("#slides").innerHTML = imgs || "<div class='preview-fallback'>No slides available</div>";
      } catch (e2) {
        console.error(e2);
        $("#answer").textContent = "I don't have enough information.";
      }
    });
  </script>
</body>
</html>
