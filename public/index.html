<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Jaice — Research Q&A</title>
  <link rel="stylesheet" href="/styles.css"/>
  <style>
    :root{
      --brand:#ff7a00; --ink:#111; --muted:#5f6570; --line:#e9edf2;
      --soft:#fff7ed; --soft-border:#ffead6; --accent-left:#ea580c;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#fff;color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
    .bar{max-width:none;width:100%;margin:0;padding:12px 24px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:baseline;gap:6px}
    .brand .cog{font-weight:800;color:#2b2f36;font-size:24px;letter-spacing:.1px}
    .brand .gpt{font-weight:400;color:var(--brand);font-size:24px;margin-left:-2px}
    .brand .beta{font-size:.78rem;color:#9aa2ad;font-weight:700;letter-spacing:.06em}
    .nav{display:flex;align-items:center;gap:10px}
    #who{color:var(--muted);font-size:.85rem}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:10px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.small{padding:10px 14px;font-size:.92rem;line-height:1;height:40px}
    .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--line)}
    .btn.ghost:hover{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.primary{background:var(--brand);color:#fff;border:0;padding:16px 24px;border-radius:18px;font-size:1.05rem}
    .client-top-below{display:none;width:100%;margin:8px 0 0;padding:0 24px;display:flex;justify-content:flex-end}
    .client-top-below select{height:40px;border-radius:10px;border:1px solid(var(--line));background:#fff;padding:0 10px;font-size:.9rem;color:var(--muted);min-width:260px;}
    main{max-width:none;width:100%;margin:24px 0 32px;padding:0 24px}
    .hero{text-align:center;margin:0 0 8px}
    .hero h1{font-size:34px;margin:0 0 6px color:var(--muted); text-transform:uppercase; letter-spacing:.04em; font-weight:800;}
    .hero h1 .dot{color:var(--brand)}
    .hero p{margin:0;color:var(--muted)}
    .askbox{display:grid;grid-template-columns:1fr 140px;gap:12px;width:100%;margin:18px auto 0}
    .askbox input{padding:18px 20px;font-size:1.05rem;border-radius:18px;border:1px solid var(--line);background:#f4f4f4;color:var(--ink)}
    .inline-thinking{display:none;align-items:center;gap:8px;color:#9aa2ad;font-size:.9rem;margin-top:6px}
    .linklike{background:none;border:0;color:#2563eb;text-decoration:underline;cursor:pointer;font-size:.9rem;padding:0}
    .panel{margin-top:22px;border:1px solid var(--line);border-radius:14px;padding:14px;background:#fff}
    .panel h3{margin:0 0 8px;font-size:.95rem;color:var(--muted);font-weight:600}
    .answer-panel{background:var(--soft);border-color:var(--soft-border);position:relative}
    .answer-panel::before{content:"";position:absolute;left:0;top:0;bottom:0;width:6px;border-radius:14px 0 0 14px;background:var(--accent-left)}
    .answer-body{line-height:1.55;font-size:1.02rem}
    #slidesGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    #slidesGrid img{width:100%;border-radius:10px;border:1px solid var(--line);background:#f8fafc;aspect-ratio:16/9;object-fit:cover}
    #dataGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .chart-card{border:1px solid var(--line);border-radius:12px;padding:10px}
    .msg{margin-top:8px;border:1px solid var(--line);background:#fff5f5;color:#8b0000;border-radius:10px;padding:10px 12px;display:none}
    .msg.info{display:block;background:#fafbfd;color:#2b2f36}

    /* NEW: Charts & Data panel styling */
    #chartsCard .canvas-wrap{border:1px solid var(--line);border-radius:12px;padding:10px}
    #chartCanvas{width:100%;height:320px;display:block}
    #chartTable{margin-top:12px;overflow:auto}
    #chartTable table{width:100%;border-collapse:collapse}
    #chartTable th,#chartTable td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:.95rem}
    #chartTable td.num{text-align:right}
    #chartFootnote{margin-top:10px;border:1px solid var(--soft-border);background:var(--soft);border-radius:10px;padding:10px 12px;font-size:.9rem;color:#5a4638;display:none}

    /* NEW: Admin pill */
    .admin-pill{
      display:inline-flex;align-items:center;justify-content:center;
      height:36px;padding:0 12px;margin-right:8px;
      border-radius:999px;border:1px solid var(--line);
      background:#fff;color:#111;font-weight:600;text-decoration:none;
    }
    .admin-pill:hover{box-shadow:0 1px 0 rgba(0,0,0,.04)}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <a href="/" class="brand" aria-label="Jaice home"><img src="/assets/Slide1.JPG?v=1" alt="Jaice" class="brand-logo"/></a>
      <div class="nav">
        <div id="who" class="hidden"></div>

        <!-- NEW: Admin button (shown only for admins via JS) -->
        <a id="adminLink" href="/admin" class="admin-pill hidden" title="Admin">Admin</a>

        <div class="profile">
          <button id="profileBtn" class="icon-btn" title="Profile" aria-haspopup="menu" aria-expanded="false">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"/>
            </svg>
          </button>
          <div id="profileMenu" class="menu hidden">
            <div class="small" id="whoMenu" style="padding:8px 12px;color:#666;"></div>
            <a href="/profile">My profile</a>
            <a href="/settings">Settings</a>
            <button id="logoutBtn" type="button">Sign out</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="client-top-below" id="clientTopRow" style="display:none;">
    <select id="clientTop"></select>
  </div>

  <main>
    <div class="hero">
      <h1>ASK ABOUT YOUR RESEARCH<span class="dot">.</span></h1>
      <p class="muted">Search across your uploaded reports, questionnaires, and data.</p>
    </div>

    <div class="askbox">
      <input id="q" placeholder="e.g., What has satisfaction for Product X looked like over the past few years?"/>
      <button id="ask" class="btn primary" disabled>Ask</button>
    </div>
    <div id="inlineStatus" class="inline-thinking"><span class="spinner sm"></span><span>Thinking…</span></div>
    <div id="msg" class="msg"></div>

    <div id="out" style="display:none;">
      <div id="answerPanel" class="panel answer-panel" style="display:none;">
        <div id="answer" class="answer-body"></div>
      </div>

      <div id="supportCard" class="panel" style="display:none;">
        <h3>Additional Support</h3>
        <ul id="supportList" class="compact-list"></ul>
        <button id="toggleMoreBtn" class="linklike" style="display:none;">Show more</button>
      </div>

      <div id="slidesCard" class="panel" style="display:none;">
        <h3>Report Slides</h3>
        <div id="slidesGrid"></div>
        <button id="toggleSlidesBtn" class="linklike" style="display:none;margin-top:8px;">Show more</button>
      </div>

      <div id="quotesCard" class="panel" style="display:none;">
        <h3>Supporting Quotes</h3>
        <div id="quotes"></div>
      </div>

      <div id="dataCard" class="panel" style="display:none;">
        <h3>Supporting Data</h3>
        <div id="dataGrid"></div>
      </div>

      <!-- NEW: Charts & Data -->
      <div id="chartsCard" class="panel" style="display:none;">
        <h3>Charts &amp; Data</h3>
        <div class="canvas-wrap">
          <canvas id="chartCanvas" aria-label="Metric chart"></canvas>
        </div>
        <div id="chartTable" class="table-wrap" style="margin-top:12px;"></div>
        <div id="chartFootnote"></div>
      </div>

      <details id="refsDetails" class="panel" style="display:none;">
        <summary>
          <h3 style="display:inline;">References</h3>
          <span class="muted" style="margin-left:8px;">(click to expand)</span>
        </summary>
        <div class="table-wrap">
          <table class="data-table" id="refsTable">
            <thead>
              <tr><th>#</th><th>Name</th><th>Month</th><th>Year</th><th>Methodology</th><th>Link</th></tr>
            </thead>
            <tbody id="refsBody"></tbody>
          </table>
        </div>
      </details>
    </div>
  </main>

  <div id="overlay" class="overlay hidden">
    <div class="spinner"></div>
    <div class="overlay-text">Thinking…</div>
  </div>

  <div id="chartTip" class="chart-tooltip"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }
  </script>

  <!-- Chart.js for /api/chart-query rendering -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Profile menu + Admin pill reveal -->
  <script>
  (function(){
    const btn  = document.getElementById("profileBtn");
    const menu = document.getElementById("profileMenu");
    if (btn && menu){
      const close = ()=>{ menu.classList.add("hidden"); btn.setAttribute("aria-expanded","false"); };
      const open  = ()=>{ menu.classList.remove("hidden"); btn.setAttribute("aria-expanded","true"); };
      btn.addEventListener("click", (e)=>{ e.stopPropagation(); (menu.classList.contains("hidden") ? open : close)(); });
      document.addEventListener("click", close);
      document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") close(); });
    }

    try{
      const roleLabel = (ME?.user?.role === "internal") ? "admin" : (ME?.user?.role || "");
      const whoMenu = document.getElementById("whoMenu");
      if (whoMenu) whoMenu.textContent = `${ME?.user?.username || ""} · ${roleLabel}`;
      const who = document.getElementById("who"); if (who){ who.textContent = `${ME?.user?.username || ""} · ${roleLabel}`; who.classList.remove("hidden"); }
      // Show Admin pill for admins
      const isAdmin = (ME?.user?.role === "admin" || ME?.user?.role === "internal") || (ME?.user?.allowedClients === "*");
      const adminLink = document.getElementById("adminLink");
      if (isAdmin && adminLink) adminLink.classList.remove("hidden");
    }catch{}
  })();
  </script>

  <script>
  let ME = null;

  // Make logout always work and then hard-redirect to login
  function wireLogout(){
    const btn = document.getElementById("logoutBtn");
    if (!btn) return;
    btn.addEventListener("click", async ()=>{
      try { await fetch("/auth/logout", { method:"POST" }); } catch {}
      window.location.replace("/login.html");
    });
  }

  // Robust /me: show role, map "internal"->"admin", and redirect to login on 401
  async function fetchMe(){
    try{
      const r = await fetch("/me", { credentials:"same-origin" });
      if (r.status === 401) {
        return window.location.replace("/login.html");
      }
      const me = await r.json();
      ME = me;
      const roleLabel = (me?.user?.role === "internal") ? "admin" : (me?.user?.role || "");
      const who = document.getElementById("who");
      if (who) who.textContent = `${me?.user?.username || ""} — ${roleLabel}`;

      const isAdmin = (roleLabel === "admin");
      document.getElementById("adminLink")?.setAttribute("style", isAdmin ? "display:inline-flex" : "display:none");
      const row = document.getElementById("clientTopRow");
      if (row) row.style.display = isAdmin ? "flex" : "none";
    }catch(e){
      window.location.replace("/login.html");
    }
  }

  // Load libraries for admin dropdown
  async function loadClientLibraries(){
    try {
      const res = await fetch("/api/client-libraries", { credentials:"same-origin" });
      if (!res.ok) return;
      const libs = await res.json();
      const topSel = document.getElementById("clientTop");
      if (!topSel) return;
      topSel.innerHTML = '<option value="" selected disabled>Select a client library</option>';
      libs.forEach(({id, name})=>{
        const opt = document.createElement("option");
        opt.value = id; opt.textContent = name;
        topSel.appendChild(opt);
      });
    } catch {}
  }

  // helpers
  function setThinking(on){
    document.getElementById("overlay")?.classList.toggle("hidden", !on);
    const inl = document.getElementById("inlineStatus");
    if (inl) inl.style.display = on ? "flex" : "none";
    const ask = document.getElementById("ask");
    if (ask) ask.disabled = on;
  }
  function showMsg(text, type="error"){
    const el = document.getElementById("msg");
    if (!el) return;
    el.textContent = text;
    el.className = "msg " + (type==="error"?"":"info");
    el.style.display = "block";
  }
  function clearMsg(){
    const el = document.getElementById("msg");
    if (!el) return;
    el.textContent = "";
    el.className = "msg";
    el.style.display = "none";
  }
  function cleanBullet(s){ return String(s||"").replace(/\s+/g," ").trim(); }
  function stripTrailPunct(s){ return String(s||"").replace(/\s*[.!?]+$/,""); }
  function splitLines(s){ return String(s||"").split(/\n+/).map(t=>t.trim()).filter(Boolean); }

  let supportAllBullets = [];
  let supportCollapsed = true;
  function renderSupportList(limit = 5){
    const ul = document.getElementById("supportList");
    const btn = document.getElementById("toggleMoreBtn");
    if (!ul || !btn) return;
    ul.innerHTML = "";
    const slice = supportCollapsed ? supportAllBullets.slice(0, limit) : supportAllBullets;
    slice.forEach(b => {
      const li = document.createElement("li");
      const noPeriod = stripTrailPunct(b);
      li.innerHTML = String(noPeriod)
        .replace(/(?:\[\d+\])+/g, (m)=>`<sup>${Array.from(m.matchAll(/\[(\d+)\]/g)).map(x=>x[1]).join(";")}</sup>`)
        .replace(/\s+\[(\d+)\]/g, "<sup>$1</sup>")
        .replace(/\[(\d+)\]/g, "<sup>$1</sup>");
      ul.appendChild(li);
    });
    if (supportAllBullets.length > limit) {
      btn.style.display = "inline";
      btn.textContent = "Show more";
      btn.textContent = supportCollapsed ? "Show more" : "Show less";
    } else btn.style.display = "none";
  }
  document.getElementById("toggleMoreBtn")?.addEventListener("click", ()=>{
    supportCollapsed = !supportCollapsed; renderSupportList();
  });

  let allSlides = []; // [{fileId,page,dataUrl?}]
  let slidesCollapsed = true;
  async function renderSlides(limit = 3){
    const grid = document.getElementById("slidesGrid");
    const btn  = document.getElementById("toggleSlidesBtn");
    if (!grid || !btn) return;
    grid.innerHTML = "";
    const slice = slidesCollapsed ? allSlides.slice(0, limit) : allSlides;
    slice.forEach(s=>{
      const img = document.createElement("img");
      img.alt = `Slide ${s.page || ""}`; img.style.opacity = "0.85";
      grid.appendChild(img);
      (async ()=>{
        try{
          const url = await renderPdfPageToDataUrl(s.fileId, s.page, 1.6);
          s.dataUrl = url; img.src = url; img.style.opacity = "1";
        }catch(e1){
          try{
            const url2 = await renderPdfPageToDataUrl(s.fileId, s.page, 1.2);
            s.dataUrl = url2; img.src = url2; img.style.opacity = "1";
          }catch{ img.alt = "Slide unavailable"; img.style.opacity = "1"; img.style.background = "#fafafa"; }
        }
      })();
    });
    if (allSlides.length > limit) {
      btn.style.display = "inline";
      btn.textContent = slidesCollapsed ? "Show more" : "Show less";
    } else btn.style.display = "none";
  }
  document.getElementById("toggleSlidesBtn")?.addEventListener("click", ()=>{
    slidesCollapsed = !slidesCollapsed; renderSlides();
  });

  const chartTip = document.getElementById("chartTip");
  function showTip(text, x, y){
    if (!chartTip) return;
    chartTip.textContent = text; chartTip.style.display = "block";
    const off = 12; chartTip.style.left = (x + off) + "px"; chartTip.style.top  = (y + off) + "px";
  }
  function hideTip(){ if (chartTip) chartTip.style.display = "none"; }

  function renderCharts(series){
    const grid = document.getElementById("dataGrid"); if (!grid) return;
    grid.innerHTML = ""; if(!Array.isArray(series) || !series.length) return;
    series.slice(0,5).forEach(s=>{
      const wrap = document.createElement("div"); wrap.className = "chart-card";
      const title = document.createElement("div"); title.style.fontWeight = "600"; title.style.marginBottom = "6px"; title.textContent = s.metric;
      const svg = document.createElementNS("http://www.w3.org/2000/svg","svg"); svg.setAttribute("width","100%"); svg.setAttribute("height","180"); svg.setAttribute("viewBox","0 0 340 180"); svg.style.display = "block";
      const pts = (s.points||[]).slice().sort((a,b)=>a.epoch-b.epoch);
      if(pts.length>=2){
        const vals = pts.map(p=>Number(p.value||0));
        const vmin = Math.min(...vals), vmax = Math.max(...vals);
        const padL=34,padR=8,padT=12,padB=28,w=340-padL-padR,h=180-padT-padB;
        const x = (i)=> padL + (w * (i/(pts.length-1||1)));
        const y = (v)=> padT + (h - (h * ((v - vmin)/(vmax - vmin || 1))));
        const axis = document.createElementNS("http://www.w3.org/2000/svg","path"); axis.setAttribute("d",`M${padL},${padT} L${padL},${padT+h} L${padL+w},${padT+h}`); axis.setAttribute("stroke","#cfd6dd"); axis.setAttribute("fill","none"); svg.appendChild(axis);
        const d = pts.map((p,i)=> (i? "L":"M")+x(i)+","+y(p.value)).join(" ");
        const path = document.createElementNS("http://www.w3.org/2000/svg","path"); path.setAttribute("d",d); path.setAttribute("stroke","#ff7a00"); path.setAttribute("fill","none"); path.setAttribute("stroke-width","2"); svg.appendChild(path);
        pts.forEach((p,i)=>{
          const cx=x(i), cy=y(p.value);
          const dot=document.createElementNS("http://www.w3.org/2000/svg","circle"); dot.setAttribute("cx",cx); dot.setAttribute("cy",cy); dot.setAttribute("r","3"); dot.setAttribute("fill","#ff7a00");
          dot.addEventListener("mouseenter",(ev)=>{ dot.setAttribute("r","5"); const label=(p.label||"").replace(/\s+/g," ").trim(); showTip(`${Math.round(p.value)}% — ${label}`, ev.clientX, ev.clientY); });
          dot.addEventListener("mousemove",(ev)=>{ showTip(chartTip.textContent, ev.clientX, ev.clientY); });
          dot.addEventListener("mouseleave",()=>{ dot.setAttribute("r","3"); hideTip(); });
          svg.appendChild(dot);
          const lbl=document.createElementNS("http://www.w3.org/2000/svg","text"); lbl.setAttribute("x",cx); lbl.setAttribute("y",padT+h+14); lbl.setAttribute("text-anchor","middle"); lbl.setAttribute("font-size","10"); lbl.textContent=(p.label||"").replace(/\s+/g," ").trim(); svg.appendChild(lbl);
        });
        const lmin=document.createElementNS("http://www.w3.org/2000/svg","text"); lmin.setAttribute("x",2); lmin.setAttribute("y",padT+h); lmin.setAttribute("font-size","10"); lmin.textContent = `${Math.round(vmin)}%`; svg.appendChild(lmin);
        const lmax=document.createElementNS("http://www.w3.org/2000/svg","text"); lmax.setAttribute("x",2); lmax.setAttribute("y",padT+8); lmax.setAttribute("font-size","10"); lmax.textContent = `${Math.round(vmax)}%`; svg.appendChild(lmax);
      }
      wrap.appendChild(title); wrap.appendChild(svg); grid.appendChild(wrap);
    });
  }

  function normalizeSupportFromAPI(raw){
    if (!raw) return [];
    const arr = Array.isArray(raw) ? raw : (Array.isArray(raw?.items) ? raw.items : []);
    return arr.map((it)=>{
      if (typeof it === "string") return { text: it, recencyEpoch: 0, refs: [] };
      const text = it.text ?? it.sentence ?? it.summary ?? "";
      const refs = Array.isArray(it.refs) ? it.refs : (Array.isArray(it.citations) ? it.citations : []);
      const rec = Number(it.recencyEpoch ?? it.epoch ?? it.timestamp ?? 0) || 0;
      let t = String(text || "").trim().replace(/\s*[.!?]+$/,"");
      if (refs.length && !/\[\d+\]/.test(t)) t += " " + refs.map(n => `[${n}]`).join("");
      return { text: t, recencyEpoch: rec, refs };
    });
  }

  // Render a PDF page to PNG data URL using server proxy
  async function renderPdfPageToDataUrl(fileId, pageNum, scale=1.6){
    if (!window.pdfjsLib) throw new Error("pdf.js not loaded");
    const url = `/api/drive-pdf?fileId=${encodeURIComponent(fileId)}`;
    const loadingTask = pdfjsLib.getDocument({ url, withCredentials: true });
    const pdf = await loadingTask.promise;
    const pageIndex = Math.max(1, Number(pageNum) || 1);
    const page = await pdf.getPage(pageIndex);
    const viewport = page.getViewport({ scale });
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = viewport.width; canvas.height = viewport.height;
    await page.render({ canvasContext: ctx, viewport }).promise;
    return canvas.toDataURL("image/png");
  }

  // --- NEW: Chart helpers bound to window.app ---
  let _chartInstance = null;

  function renderChartPayload(payload){
    const panel = document.getElementById("chartsCard");
    const canvas = document.getElementById("chartCanvas");
    const tableWrap = document.getElementById("chartTable");
    const foot = document.getElementById("chartFootnote");
    if (!panel || !canvas || !tableWrap || !payload) return;

    panel.style.display = "block";

    const ctx = canvas.getContext("2d");
    if (_chartInstance) { _chartInstance.destroy(); _chartInstance = null; }
    const cfg = {
      type: (payload.chart?.type === "bar" ? "bar" : "line"),
      data: {
        labels: payload.chart?.labels || [],
        datasets: (payload.chart?.datasets || []).map(ds => ({
          label: ds.label || "Series",
          data: ds.data || [],
          tension: 0.25,
          borderWidth: 2,
          pointRadius: 3,
          fill: false
        }))
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { ticks: { callback: (v)=> v + (payload.meta?.unit === "pct" ? "%" : "") } }
        },
        plugins: { legend: { display: true } }
      }
    };
    _chartInstance = new Chart(ctx, cfg);

    const rows = Array.isArray(payload.table) ? payload.table : [];
    let html = '<table class="data-table"><thead><tr>';
    if (rows.length){
      const cols = Object.keys(rows[0]);
      cols.forEach(c => html += `<th>${c}</th>`);
      html += '</tr></thead><tbody>';
      rows.forEach(r=>{
        html += '<tr>';
        cols.forEach(c=>{
          const v = r[c];
          const num = typeof v === "number";
          html += `<td class="${num?'num':''}">${num ? Math.round(v*100)/100 : String(v)}</td>`;
        });
        html += '</tr>';
      });
      html += '</tbody></table>';
    } else {
      html = '<div class="muted">No table data.</div>';
    }
    tableWrap.innerHTML = html;

    const note = payload.footnote || "";
    if (note) { foot.textContent = note; foot.style.display = "block"; }
    else { foot.textContent = ""; foot.style.display = "none"; }
  }

  async function fetchChartForMetric(metricId){
    const isAdmin = ((ME?.user?.role === "admin") || (ME && (ME.user?.role === "internal")));
    const clientId = isAdmin ? (document.getElementById("clientTop")?.value || "") : "";
    const qs = new URLSearchParams();
    if (clientId) qs.set("clientId", clientId);
    qs.set("metricId", metricId);

    const r = await fetch(`/api/chart-query?${qs.toString()}`, { credentials:"same-origin" });
    if (!r.ok){
      showMsg("No chart data found for that metric.");
      return;
    }
    const payload = await r.json();
    renderChartPayload(payload);
  }

  window.app = Object.assign(window.app || {}, {
    showChart: renderChartPayload,
    fetchChart: fetchChartForMetric
  });

  async function doAsk(){
    clearMsg();
    const qEl = document.getElementById("q");
    const question = String(qEl?.value||"").trim();
    const isAdmin = ((ME?.user?.role === "admin") || (ME && (ME.user?.role === "internal")));
    const clientId = isAdmin ? (document.getElementById("clientTop")?.value || "") : "";

    if (isAdmin && !clientId) return showMsg("Select a client library before asking.");
    if (!question) return showMsg("Enter a question to search.");

    setThinking(true);
    try{
      const res = await fetch("/search", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ userQuery: question, clientId: clientId || null, generateSupport: true })
      });
      const data = await res.json();

      document.getElementById("out")?.setAttribute("style","display:block;");

      const ansPanel = document.getElementById("answerPanel");
      const ans = document.getElementById("answer");
      if (ans) ans.innerHTML = "";
      if (data?.answer && ansPanel && ans){
        ansPanel.style.display = "block";
        ans.innerHTML = String(data.answer)
          .replace(/(?:\[\d+\])+/g, (m)=>`<sup>${Array.from(m.matchAll(/\[(\d+)\]/g)).map(x=>x[1]).join(";")}</sup>`)
          .replace(/\s+\[(\d+)\]/g, "<sup>$1</sup>")
          .replace(/\[(\d+)\]/g, "<sup>$1</sup>");
      } else if (ansPanel){ ansPanel.style.display = "none"; }

      const supportCard = document.getElementById("supportCard");
      const ctxChunks = Array.isArray(data?.references?.chunks) ? data.references.chunks : [];
      let structured = normalizeSupportFromAPI(data?.supportingBullets || data?.supporting || data?.structured?.supporting);
      structured.sort((a,b) => (b.recencyEpoch||0) - (a.recencyEpoch||0));
      if (!structured.length) {
        const snippets = ctxChunks.map(c => c?.textSnippet || "").filter(Boolean);
        const fallback = snippets.flatMap(s=>String(s).split(/\n+/)).map(t=>t.trim()).filter(Boolean);
        structured = fallback.map(t => ({ text: t, recencyEpoch: 0, refs: [] }));
      }
      const answerText = String(data?.answer || "");
      const seen = new Set(); const bullets = [];
      for (const s of structured) {
        const trimmed = String(s.text||"").replace(/\s+/g," ").trim();
        if (!trimmed) continue;
        const key = trimmed.toLowerCase();
        if (answerText.toLowerCase().includes(key)) continue;
        if (seen.has(key)) continue;
        seen.add(key);
        bullets.push(trimmed.replace(/\s*[.!?]+$/,""));
      }
      supportAllBullets = bullets;
      if (supportAllBullets.length && supportCard){ supportCard.style.display = "block"; supportCollapsed = true; renderSupportList(5); }
      else if (supportCard){ supportCard.style.display = "none"; }

      const slidesCard = document.getElementById("slidesCard");
      const slidesGrid = document.getElementById("slidesGrid");
      if (slidesGrid) slidesGrid.innerHTML = "";
      const slidePairs = []; const seenSlide = new Set(); const seenFileFallback = new Set();
      (ctxChunks||[]).forEach(ch=>{
        const fid = ch.fileId || ch.id || ch.driveId || null;
        const page = ch.page || ch.pageNum || ch.pageNumber || null;
        if (!fid) return;
        if (page) {
          const k = `${fid}:${page}`; if (seenSlide.has(k)) return; seenSlide.add(k);
          slidePairs.push({fileId: fid, page: Number(page)});
        } else if (!seenFileFallback.has(fid) && seenFileFallback.size < 6) {
          seenFileFallback.add(fid); slidePairs.push({ fileId: fid, page: 1 });
        }
      });
      allSlides = slidePairs.slice(0,12).map(sp => ({...sp, dataUrl: null}));
      if (allSlides.length){ slidesCard.style.display = "block"; slidesCollapsed = true; renderSlides(3); }
      else { slidesCard.style.display = "none"; }

      const quotesCard = document.getElementById("quotesCard");
      const quotesEl = document.getElementById("quotes");
      if (quotesEl) quotesEl.innerHTML = "";
      const quotes = Array.isArray(data?.quotes) ? data.quotes.slice(0,5) : [];
      quotes.forEach(q=>{
        const bq=document.createElement("blockquote");
        bq.innerHTML = String(q).replace(/\s*[.!?]+$/,"")
          .replace(/(?:\[\d+\])+/g, (m)=>`<sup>${Array.from(m.matchAll(/\[(\d+)\]/g)).map(x=>x[1]).join(";")}</sup>`)
          .replace(/\s+\[(\d+)\]/g, "<sup>$1</sup>")
          .replace(/\[(\d+)\]/g, "<sup>$1</sup>");
        quotesEl?.appendChild(bq);
      });
      if (quotesCard) quotesCard.style.display = quotes.length ? "block" : "none";

      const series = Array.isArray(data?.supportingData) ? data.supportingData : [];
      const dataCard = document.getElementById("dataCard");
      if (dataCard) dataCard.style.display = series.length ? "block" : "none";
      renderCharts(series);

      const refsDetails = document.getElementById("refsDetails");
      const tbody = document.getElementById("refsBody");
      if (tbody) tbody.innerHTML = "";
      ctxChunks.forEach((r,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${(r.study || r.fileName || "").trim()}</td>
          <td>${(r.monthTag||"").trim()}</td>
          <td>${(r.yearTag||"").trim()}</td>
          <td>${(r.reportTag||"").trim()}</td>
          <td><a href="${r.fileUrl||"#"}" target="_blank" rel="noopener">open source</a></td>
        `;
        tbody?.appendChild(tr);
      });
      if (refsDetails) refsDetails.style.display = ctxChunks.length ? "block" : "none";

      const metricGuess = (window.App && window.app?.guessMetricIdFromQuestion)
        ? window.app?.guessMetricIdFromQuestion(question)
        : null;
      if (metricGuess) {
        try { await window.app?.fetchChart(metricGuess); } catch {}
      }

    }catch(e){
      showMsg("Search failed. Please try again.");
    }finally{
      setThinking(false);
    }
  }

  (async function init(){
    wireLogout();
    await fetchMe();
    await loadClientLibraries();
    const ask = document.getElementById("ask");
    if (ask) ask.disabled = false;
    ask?.addEventListener("click", doAsk);
    document.getElementById("q")?.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){ e.preventDefault(); doAsk(); }
    });
  })();
  </script>

  <!-- keep for any shared functionality that your project already uses -->
  <script src="/app.js" defer></script>
</body>
</html>
