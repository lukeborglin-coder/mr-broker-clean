<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cognitive Consulting — Research Q&A</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    :root { --brand:#ef6c00; }
    .page { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
    .title { font-size: 28px; font-weight: 700; }
    .logo-small { height: 28px; opacity:.9 }
    .search { display:flex; gap:8px; align-items:center; }
    .search input { flex:1; padding:12px 14px; border:1px solid #e2e8f0; border-radius:10px; outline:none; }
    .search button { background:var(--brand); color:#fff; border:none; border-radius:10px; padding:10px 16px; cursor:pointer; font-weight:600; }
    .card { border:1px solid #e2e8f0; border-radius:12px; padding:14px 16px; margin-top:14px; }
    .card h3 { margin:0 0 6px 0; font-size:18px; }
    .muted { color:#6b7280; }
    .refs { display:flex; flex-direction:column; gap:6px; margin-top:8px; }
    .ref a { text-decoration:none; }
    .bullets { margin:8px 0 0 18px; }
    .visuals { display:grid; gap:10px; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); margin-top:8px; }
    .visual { border:1px solid #e5e7eb; border-radius:10px; padding:8px; }
    .visual img { width:100%; height:auto; border-radius:8px; display:block; }
    .small { font-size:12px; color:#6b7280; }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <h1 class="title">Research Q&amp;A</h1>
      <img src="/assets/Cog_OUTLOOK_SIG.png" alt="Cognitive Consulting" class="logo-small" />
    </header>

    <section class="card">
      <div class="search">
        <input id="q" placeholder="Ask a question about your research…" />
        <button id="ask">Ask</button>
      </div>
      <div id="status" class="small muted" style="margin-top:6px;"></div>
    </section>

    <section class="card">
      <h3>Key Findings</h3>
      <div id="answer" class="muted">Ask a question to see findings.</div>
    </section>

    <section class="card">
      <h3>Supporting Details</h3>
      <div id="visuals" class="visuals muted">No supporting visuals found.</div>
    </section>

    <section class="card">
      <h3>References</h3>
      <div id="refs" class="refs muted">No references detected.</div>
      <div id="sources" class="bullets small"></div>
    </section>
  </div>

 <script>
  // --- config ---
  const API_BASE = "https://mr-broker.onrender.com";
  const AUTH     = "Jrx4cukgLvuj5jFs4mU0U5ckL+UxHfkrL5pHY+xr5Hw=";
  const CLIENT   = "genentech";

  // --- elements (these IDs must exist in your HTML) ---
  const elQ    = document.getElementById("q");
  const elAsk  = document.getElementById("ask");
  const elAns  = document.getElementById("answer");
  const elVis  = document.getElementById("visuals");
  const elRefs = document.getElementById("refs");

  // --- helpers ---
  const t = (x) => (x ?? "").toString().trim();

  function renderAnswer(answerText) {
    const txt = t(answerText);
    elAns.textContent = txt || "No findings.";
    elAns.classList.toggle("muted", !txt);
  }

  function renderVisuals(visuals) {
    elVis.innerHTML = "";
    if (!Array.isArray(visuals) || visuals.length === 0) {
      elVis.textContent = "No supporting visuals found.";
      elVis.classList.add("muted");
      return;
    }
    elVis.classList.remove("muted");
    visuals.forEach(v => {
      const url = v?.imageUrl || v?.thumbUrl || v?.url;
      const cap = v?.caption || v?.title || "";
      const wrap = document.createElement("div");
      wrap.style.marginBottom = "8px";
      wrap.innerHTML = url
        ? `<a href="${url}" target="_blank" rel="noopener"><img src="${url}" style="max-width:100%;border-radius:8px"></a>
           <div class="small">${t(cap)}</div>`
        : `<div class="small">[image missing]</div>`;
      elVis.appendChild(wrap);
    });
  }

  function renderReferences(refs) {
    elRefs.innerHTML = "";
    if (!Array.isArray(refs) || refs.length === 0) {
      elRefs.textContent = "No references detected.";
      elRefs.classList.add("muted");
      return;
    }
    elRefs.classList.remove("muted");

    refs.forEach(ref => {
      const title = t(ref?.title || ref?.name || ref?.fileName || "Untitled");
      const url   = ref?.url || ref?.link || ref?.fileUrl || "#";
      const page  = ref?.page != null ? ` (p.${ref.page})`
                 : ref?.slide != null ? ` (slide ${ref.slide})` : "";
      const row   = document.createElement("div");
      if (url && url !== "#") {
        row.innerHTML = `<a href="${url}" target="_blank" rel="noopener">${title}${page}</a>`;
      } else {
        row.textContent = `${title}${page}`;
      }
      elRefs.appendChild(row);
    });
  }

  async function askQuestion() {
    const userQuery = t(elQ.value);
    if (!userQuery) return;

    // optimistic placeholders
    elAns.textContent = "Thinking…";
    elAns.classList.remove("muted");
    elVis.textContent = "Loading visuals…";
    elRefs.textContent = "Loading references…";

    try {
      const res = await fetch(`${API_BASE}/search`, {
        method: "POST",
        headers: {
          "x-auth-token": AUTH,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ clientId: CLIENT, userQuery, topK: 6 })
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      renderAnswer(data?.answer || data?.summary || "");
      renderVisuals(data?.visuals || data?.charts || []);
      renderReferences(data?.references || data?.refs || data?.sources || []);
    } catch (e) {
      console.error(e);
      elAns.textContent  = "Something went wrong.";
      elVis.textContent  = "No supporting visuals found.";
      elRefs.textContent = "No references detected.";
      elAns.classList.add("muted");
      elVis.classList.add("muted");
      elRefs.classList.add("muted");
    }
  }

  elAsk.addEventListener("click", askQuestion);
  elQ.addEventListener("keydown", (e) => { if (e.key === "Enter") askQuestion(); });
</script>

</body>
</html>
