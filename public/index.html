<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cognitive Consulting — Research Q&A</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    :root { --brand:#ef6c00; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    .page { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
    .title { font-size: 28px; font-weight: 700; }
    .logo-small { height: 28px; opacity:.9 }
    .card { border:1px solid #e2e8f0; border-radius:12px; padding:14px 16px; margin-top:14px; }
    .card h3 { margin:0 0 6px 0; font-size:18px; }
    .muted { color:#6b7280; }
    .search { display:flex; gap:8px; align-items:center; }
    .search input { flex:1; padding:12px 14px; border:1px solid #e2e8f0; border-radius:10px; outline:none; }
    .search button { background:var(--brand); color:#fff; border:none; border-radius:10px; padding:10px 16px; cursor:pointer; font-weight:600; }
    .visuals { display:grid; gap:10px; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); margin-top:8px; }
    .visual { border:1px solid #e5e7eb; border-radius:10px; padding:8px; }
    .visual img { width:100%; height:auto; border-radius:8px; display:block; }
    .small { font-size:12px; color:#6b7280; }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <h1 class="title">Research Q&amp;A</h1>
      <img src="/assets/Cog_OUTLOOK_SIG.png" alt="Cognitive Consulting" class="logo-small" />
    </header>

    <section class="card">
      <div class="search">
        <input id="q" placeholder="Ask a question about your research…" />
        <button id="ask">Ask</button>
      </div>
      <div id="status" class="small muted" style="margin-top:6px;"></div>
    </section>

    <section class="card">
      <h3>Key Findings</h3>
      <div id="answer" class="muted">Ask a question to see findings.</div>
    </section>

    <section class="card">
      <h3>Supporting Details</h3>
      <div id="visuals" class="visuals muted">No supporting visuals found.</div>
    </section>

    <section class="card">
      <h3>References</h3>
      <div id="refs" class="muted">No references detected.</div>
    </section>
  </div>

  <script>
    const API_BASE = window.location.origin; // same host (Render)
    const CLIENT   = "genentech";            // namespace to search

    const elQ      = document.getElementById("q");
    const elAsk    = document.getElementById("ask");
    const elStatus = document.getElementById("status");
    const elAns    = document.getElementById("answer");
    const elVis    = document.getElementById("visuals");
    const elRefs   = document.getElementById("refs");

    function t(x){ return (x ?? "").toString().trim(); }

    function renderAnswer(s){
      const txt = t(s);
      elAns.textContent = txt || "No findings.";
      elAns.classList.toggle("muted", !txt);
    }

    function renderVisuals(arr){
      elVis.innerHTML = "";
      if (!Array.isArray(arr) || arr.length === 0){
        elVis.textContent = "No supporting visuals found.";
        elVis.classList.add("muted");
        return;
      }
      elVis.classList.remove("muted");
      arr.forEach(v => {
        const url = v?.imageUrl || v?.thumbUrl || v?.url;
        const cap = v?.caption || v?.title || "";
        const d = document.createElement("div");
        d.className = "visual";
        d.innerHTML = url
          ? `<a href="${url}" target="_blank" rel="noopener"><img src="${url}"></a><div class="small">${t(cap)}</div>`
          : `<div class="small">[image missing]</div>`;
        elVis.appendChild(d);
      });
    }

    function renderReferences(refs){
      elRefs.innerHTML = "";
      if (!Array.isArray(refs) || refs.length === 0){
        elRefs.textContent = "No references detected.";
        elRefs.classList.add("muted");
        return;
      }
      elRefs.classList.remove("muted");
      refs.forEach(r => {
        const name = r?.fileName || r?.title || r?.name || "Untitled";
        const page = (r?.page != null) ? ` (p.${r.page})` : "";
        const div = document.createElement("div");
        div.textContent = `${name}${page}`;
        elRefs.appendChild(div);
      });
    }

    async function ask(){
      const userQuery = t(elQ.value);
      if (!userQuery) return;
      elStatus.textContent = "Thinking…";
      elAns.textContent = "";
      elRefs.textContent = "Loading references…";
      elVis.textContent = "Loading visuals…";

      try {
        const res = await fetch(`${API_BASE}/search`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-auth-token": "" }, // token is checked on server; if set, add here
          body: JSON.stringify({ clientId: CLIENT, userQuery, topK: 6 })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        renderAnswer(data?.answer || "");
        renderVisuals(data?.visuals || []);
        renderReferences(data?.references || []);
        elStatus.textContent = "";
      } catch (e) {
        console.error(e);
        elStatus.textContent = "Error: " + (e.message || e);
        renderAnswer("");
        renderVisuals([]);
        renderReferences([]);
      }
    }

    elAsk.addEventListener("click", ask);
    elQ.addEventListener("keydown", e => { if (e.key === "Enter") ask(); });
  </script>
</body>
</html>
