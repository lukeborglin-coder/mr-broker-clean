<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>COGgpt — Research Q&A</title>
  <link rel="stylesheet" href="/styles.css"/>
  <style>
    :root{
      --brand:#ff7a00; --ink:#111; --muted:#5f6570; --line:#e9edf2;
      --soft:#fff7ed; --soft-border:#ffead6; --accent-left:#ea580c;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#fff;color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}

    /* Full-width header bar */
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
    .bar{max-width:none;width:100%;margin:0;padding:12px 24px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:baseline;gap:6px}
    .brand .cog{font-weight:800;color:#2b2f36;font-size:24px;letter-spacing:.1px}
    .brand .gpt{font-weight:400;color:var(--brand);font-size:24px;margin-left:-2px}
    .brand .beta{font-size:.78rem;color:#9aa2ad;font-weight:700;letter-spacing:.06em}
    .nav{display:flex;align-items:center;gap:10px}
    #who{color:var(--muted);font-size:.85rem}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:10px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.small{padding:10px 14px;font-size:.92rem;line-height:1;height:40px}
    .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--line)}
    .btn.ghost:hover{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.primary{background:var(--brand);color:#fff;border:0;padding:16px 24px;border-radius:18px;font-size:1.05rem}

    /* admin client dropdown (below header, right-aligned) */
    .client-top-below{display:none;width:100%;margin:8px 0 0;padding:0 24px;display:flex;justify-content:flex-end}
    .client-top-below select{
      height:40px;border-radius:10px;border:1px solid var(--line);
      background:#fff;padding:0 10px;font-size:.9rem;color:var(--muted);min-width:260px;
    }

    /* Full-width main */
    main{max-width:none;width:100%;margin:24px 0 32px;padding:0 24px}
    .hero{text-align:center;margin:0 0 8px}
    .hero h1{font-size:34px;margin:0 0 6px}
    .hero h1 .dot{color:var(--brand)}
    .hero p{margin:0;color:var(--muted)}

    .askbox{display:grid;grid-template-columns:1fr 140px;gap:12px;width:100%;margin:18px auto 0}
    .askbox input{padding:18px 20px;font-size:1.05rem;border-radius:18px;border:1px solid var(--line);background:#f4f4f4;color:var(--ink)}
    .inline-thinking{display:none;align-items:center;gap:8px;color:var(--muted);font-size:.9rem;margin-top:6px}
    .linklike{background:none;border:0;color:#2563eb;text-decoration:underline;cursor:pointer;font-size:.9rem;padding:0}

    .panel{margin-top:22px;border:1px solid var(--line);border-radius:14px;padding:14px;background:#fff}
    .panel h3{margin:0 0 8px;font-size:.95rem;color:var(--muted);font-weight:600}
    .answer-panel{background:var(--soft);border-color:var(--soft-border);position:relative}
    .answer-panel::before{content:"";position:absolute;left:0;top:0;bottom:0;width:6px;border-radius:14px 0 0 14px;background:var(--accent-left)}
    .answer-body{line-height:1.55;font-size:1.02rem}
    .answer-bullets{margin:8px 0 0;padding-left:18px}
    .answer-bullets li{margin:4px 0}

    /* supporting lists */
    #supportCard ul{margin:0;padding-left:18px}
    #supportCard li{margin:6px 0}

    /* quotes */
    #quotesCard blockquote{margin:0 0 10px 0;font-style:italic}
    #quotesCard .tag{color:var(--muted)}

    /* report examples (slides) */
    #slidesGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    #slidesGrid img{width:100%;border-radius:10px;border:1px solid var(--line)}

    /* supporting data (charts) */
    #dataGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .chart-card{border:1px solid var(--line);border-radius:12px;padding:10px}

    .msg{margin-top:8px;border:1px solid var(--line);background:#fff5f5;color:#8b0000;border-radius:10px;padding:10px 12px;display:none}
    .msg.info{display:block;background:#fafbfd;color:#2b2f36}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <span class="cog">COG</span><span class="gpt">gpt</span><span class="beta">(BETA)</span>
      </div>
      <div class="nav">
        <div id="who"></div>
        <a id="adminLink" class="btn small ghost" href="/admin" style="display:none;">Admin</a>
        <button id="logoutBtn" class="btn small ghost" title="Sign out">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Admin-only client picker, shown under the top bar -->
  <div class="client-top-below" id="clientTopRow" style="display:none;">
    <select id="clientTop"></select>
  </div>

  <main>
    <div class="hero">
      <h1>Ask about your research<span class="dot">.</span></h1>
      <p class="muted">Search across your uploaded reports, questionnaires, and data.</p>
    </div>

    <div class="askbox">
      <input id="q" placeholder="e.g., What has satisfaction for Product X looked like over the past few years?"/>
      <button id="ask" class="btn primary" disabled>Ask</button>
    </div>
    <div id="inlineStatus" class="inline-thinking"><span class="spinner sm"></span><span>Thinking…</span></div>
    <div id="msg" class="msg"></div>

    <div id="out" style="display:none;">
      <div id="answerPanel" class="panel answer-panel" style="display:none;">
        <div id="answer" class="answer-body"></div>
      </div>

      <div id="supportCard" class="panel" style="display:none;">
        <h3>Additional Support</h3>
        <ul id="supportList" class="compact-list"></ul>
        <button id="toggleMoreBtn" class="linklike" style="display:none;">Show more</button>
      </div>

      <div id="quotesCard" class="panel" style="display:none;">
        <h3>Supporting Quotes</h3>
        <div id="quotes"></div>
      </div>

      <div id="slidesCard" class="panel" style="display:none;">
        <h3>Supporting Slides</h3>
        <div id="slidesGrid"></div>
      </div>

      <div id="dataCard" class="panel" style="display:none;">
        <h3>Supporting Data</h3>
        <div id="dataGrid"></div>
      </div>

      <!-- Collapsed references table -->
      <details id="refsDetails" class="panel" style="display:none;">
        <summary>
          <h3 style="display:inline;">References</h3>
          <span class="muted" style="margin-left:8px;">(click to expand)</span>
        </summary>
        <div class="table-wrap">
          <table class="data-table" id="refsTable">
            <thead>
              <tr><th>#</th><th>Name</th><th>Month</th><th>Year</th><th>Methodology</th><th>Link</th></tr>
            </thead>
            <tbody id="refsBody"></tbody>
          </table>
        </div>
      </details>
    </div>
  </main>

  <!-- Full-screen loading overlay -->
  <div id="overlay" class="overlay hidden">
    <div class="spinner"></div>
    <div class="overlay-text">Thinking…</div>
  </div>

<script>
// --- Role-aware header + client library placement ---
let ME = null;

async function fetchMe(){
  try{
    const r = await fetch("/me");
    if(!r.ok) throw new Error("not signed in");
    const me = await r.json();
    ME = me;
    const who = document.getElementById("who");
    if (who) who.textContent = `${me.user.username} — ${me.user.role}`;
    if(me.user.role === "admin"){
      const row = document.getElementById("clientTopRow");
      if (row) row.style.display = "flex";
    }
    const adminLink = document.getElementById("adminLink");
    if (adminLink) adminLink.style.display = (me.user.role === "admin") ? "inline-flex" : "none";
  }catch(e){
    console.warn(e);
  }
}

// populate admin dropdown (no preselected library)
async function loadClientLibraries(){
  try {
    const res = await fetch("/api/client-libraries");
    const libs = await res.json();
    const topSel = document.getElementById("clientTop");
    if (topSel) {
      topSel.innerHTML = '<option value="" selected disabled>Select a client library</option>';
      libs.forEach(({id, name})=>{
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = name;
        topSel.appendChild(opt);
      });
    }
  } catch(e) {
    console.error("Failed to load client libraries", e);
  }
}

// helpers
function setThinking(on){
  document.getElementById("overlay")?.classList.toggle("hidden", !on);
  const inl = document.getElementById("inlineStatus");
  if (inl) inl.style.display = on ? "flex" : "none";
  const ask = document.getElementById("ask");
  if (ask) ask.disabled = on;
}
function showMsg(text, type="error"){
  const el = document.getElementById("msg");
  if (!el) return;
  el.textContent = text;
  el.className = "msg " + (type==="error"?"":"info");
  el.style.display = "block";
}
function clearMsg(){
  const el = document.getElementById("msg");
  if (!el) return;
  el.textContent = "";
  el.className = "msg";
  el.style.display = "none";
}

// text cleanup
function cleanBullet(s){ return String(s||"").replace(/\.\s*$/,""); }
function splitLines(s){ return String(s||"").split(/\n+/).map(t=>t.trim()).filter(Boolean); }

// “Show more/less” state
let supportAllBullets = [];
let supportCollapsed = true;

function renderSupportList(limit = 5){
  const ul = document.getElementById("supportList");
  const btn = document.getElementById("toggleMoreBtn");
  if (!ul || !btn) return;

  ul.innerHTML = "";
  const slice = supportCollapsed ? supportAllBullets.slice(0, limit) : supportAllBullets;
  slice.forEach(b => { const li = document.createElement("li"); li.textContent = b; ul.appendChild(li); });

  if (supportAllBullets.length > limit) {
    btn.style.display = "inline";
    btn.textContent = supportCollapsed ? "Show more" : "Show less";
  } else {
    btn.style.display = "none";
  }
}

document.getElementById("toggleMoreBtn")?.addEventListener("click", ()=>{
  supportCollapsed = !supportCollapsed;
  renderSupportList();
});

// charts
function renderCharts(series){
  const grid = document.getElementById("dataGrid");
  if (!grid) return;
  grid.innerHTML = "";
  if(!Array.isArray(series) || !series.length) return;

  series.slice(0,5).forEach(s=>{
    const wrap = document.createElement("div");
    wrap.className = "chart-card";
    const title = document.createElement("div");
    title.style.fontWeight = "600";
    title.style.marginBottom = "6px";
    title.textContent = s.metric;
    const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.setAttribute("width","100%");
    svg.setAttribute("height","160");
    svg.setAttribute("viewBox","0 0 320 160");
    svg.style.display = "block";
    const pts = (s.points||[]).slice().sort((a,b)=>a.epoch-b.epoch);
    if(pts.length>=2){
      const vals = pts.map(p=>Number(p.value||0));
      const vmin = Math.min(...vals);
      const vmax = Math.max(...vals);
      const padL=28,padR=8,padT=12,padB=22,w=320-padL-padR,h=160-padT-padB;
      const x = (i)=> padL + (w * (i/(pts.length-1||1)));
      const y = (v)=> padT + (h - (h * ((v - vmin)/(vmax - vmin || 1))));
      const axis = document.createElementNS("http://www.w3.org/2000/svg","path");
      axis.setAttribute("d",`M${padL},${padT} L${padL},${padT+h} L${padL+w},${padT+h}`);
      axis.setAttribute("stroke","#cfd6dd"); axis.setAttribute("fill","none");
      svg.appendChild(axis);
      const d = pts.map((p,i)=> (i? "L":"M")+x(i)+","+y(p.value)).join(" ");
      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d",d); path.setAttribute("stroke","#ff7a00"); path.setAttribute("fill","none"); path.setAttribute("stroke-width","2");
      svg.appendChild(path);
      pts.forEach((p,i)=>{
        const cx=x(i), cy=y(p.value);
        const dot=document.createElementNS("http://www.w3.org/2000/svg","circle");
        dot.setAttribute("cx",cx); dot.setAttribute("cy",cy); dot.setAttribute("r","3"); dot.setAttribute("fill","#ff7a00");
        svg.appendChild(dot);
        const lbl=document.createElementNS("http://www.w3.org/2000/svg","text");
        lbl.setAttribute("x",cx); lbl.setAttribute("y",padT+h+14);
        lbl.setAttribute("text-anchor","middle"); lbl.setAttribute("font-size","10");
        lbl.textContent=(p.label||"").replace(/\s+/g," ").trim();
        svg.appendChild(lbl);
      });
      const lmin=document.createElementNS("http://www.w3.org/2000/svg","text");
      lmin.setAttribute("x",2); lmin.setAttribute("y",padT+h); lmin.setAttribute("font-size","10");
      lmin.textContent = `${Math.round(vmin)}%`;
      svg.appendChild(lmin);
      const lmax=document.createElementNS("http://www.w3.org/2000/svg","text");
      lmax.setAttribute("x",2); lmax.setAttribute("y",padT+8); lmax.setAttribute("font-size","10");
      lmax.textContent = `${Math.round(vmax)}%`;
      svg.appendChild(lmax);
    }
    wrap.appendChild(title);
    wrap.appendChild(svg);
    grid.appendChild(wrap);
  });
}

function dedupeAgainstAnswer(bullets, answerText){
  const a = String(answerText||"").toLowerCase().replace(/\s+/g," ").trim();
  const out = [];
  const seen = new Set();
  for (const b of bullets){
    const key = String(b).toLowerCase().replace(/\s+/g," ").trim();
    if (a.includes(key)) continue;
    if (seen.has(key)) continue;
    seen.add(key); out.push(b);
  }
  return out;
}

async function doAsk(){
  clearMsg();
  const qEl = document.getElementById("q");
  const question = String(qEl?.value||"").trim();
  const isAdmin = (ME?.user?.role === "admin");
  const clientId = isAdmin ? (document.getElementById("clientTop")?.value || "") : "";

  if (isAdmin && !clientId) {
    showMsg("Select a client library before asking.");
    return;
  }
  if(!question){
    showMsg("Enter a question to search.");
    return;
  }

  setThinking(true);
  try{
    const res = await fetch("/search", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ userQuery: question, clientId: clientId || null })
    });
    const data = await res.json();

    document.getElementById("out")?.setAttribute("style","display:block;");

    // Answer
    const ansPanel = document.getElementById("answerPanel");
    const ans = document.getElementById("answer");
    if (ans) ans.innerHTML = "";
    if(data?.answer && ansPanel && ans){
      ansPanel.style.display = "block";
      // Superscript [n] refs and remove preceding spaces using App helper (fallback safe)
      if (window.App?.setHTMLWithRefs) {
        window.App.setHTMLWithRefs(ans, data.answer);
      } else {
        ans.textContent = data.answer; // safe fallback
      }
    }else if (ansPanel){
      ansPanel.style.display = "none";
    }

    // Additional Support — derive clean bullets from reference snippets
    const support = document.getElementById("supportList");
    const supportCard = document.getElementById("supportCard");
    if (support) support.innerHTML = "";
    const ctxChunks = Array.isArray(data?.references?.chunks) ? data.references.chunks : [];

    const snippets = ctxChunks.map(c => c?.textSnippet || "").filter(Boolean);
    let bullets = [];
    if (window.App?.deriveSupportBullets) {
      bullets = window.App.deriveSupportBullets(snippets, { maxCount: 12, maxLen: 180 });
    } else {
      // minimal fallback if helper not available
      bullets = snippets.flatMap(splitLines).map(cleanBullet);
    }
    // De‑dupe against the main answer text
    bullets = dedupeAgainstAnswer(bullets, data?.answer);

    supportAllBullets = bullets;
    if (supportAllBullets.length && supportCard){
      supportCard.style.display = "block";
      supportCollapsed = true;
      renderSupportList(5);
    } else if (supportCard){
      supportCard.style.display = "none";
    }

    // Quotes (limit 5)
    const quotesCard = document.getElementById("quotesCard");
    const quotesEl = document.getElementById("quotes");
    if (quotesEl) quotesEl.innerHTML = "";
    const quotes = Array.isArray(data?.quotes) ? data.quotes.slice(0,5) : [];
    quotes.forEach(q=>{
      const bq=document.createElement("blockquote"); bq.textContent = q;
      quotesEl?.appendChild(bq);
    });
    if (quotesCard) quotesCard.style.display = quotes.length ? "block" : "none";

    // Slides (limit 5)
    const slides = Array.isArray(data?.reportExamples) ? data.reportExamples.slice(0,5) : [];
    const slidesGrid = document.getElementById("slidesGrid");
    if (slidesGrid) slidesGrid.innerHTML = "";
    slides.forEach(s=>{
      const img = document.createElement("img");
      img.src = s.url;
      img.alt = "Slide";
      slidesGrid?.appendChild(img);
    });
    document.getElementById("slidesCard")?.setAttribute("style", slides.length ? "display:block;" : "display:none;");

    // Supporting Data
    const series = Array.isArray(data?.supportingData) ? data.supportingData : [];
    const dataCard = document.getElementById("dataCard");
    if (dataCard) dataCard.style.display = series.length ? "block" : "none";
    renderCharts(series);

    // References table
    const refsDetails = document.getElementById("refsDetails");
    const tbody = document.getElementById("refsBody");
    if (tbody) tbody.innerHTML = "";
    ctxChunks.forEach((r,i)=>{
      const tr = document.createElement("tr");
      const name = (r.study || r.fileName || "").trim();
      const month = (r.monthTag||"").trim();
      const year = (r.yearTag||"").trim();
      const method = (r.reportTag||"").trim();
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${name}</td>
        <td>${month}</td>
        <td>${year}</td>
        <td>${method}</td>
        <td><a href="${r.fileUrl||"#"}" target="_blank" rel="noopener">open source</a></td>
      `;
      tbody?.appendChild(tr);
    });
    if (refsDetails) refsDetails.style.display = ctxChunks.length ? "block" : "none";

  }catch(e){
    console.error(e);
    showMsg("Search failed. Please try again.");
  }finally{
    setThinking(false);
  }
}

// init
(async function init(){
  await fetchMe();
  await loadClientLibraries();
  const ask = document.getElementById("ask");
  if (ask) ask.disabled = false;

  // submit handlers
  ask?.addEventListener("click", doAsk);
  document.getElementById("q")?.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){ e.preventDefault(); doAsk(); }
  });
})();

// logout
document.getElementById("logoutBtn")?.addEventListener("click", async ()=>{
  await fetch("/auth/logout",{method:"POST"});
  location.href="/login.html";
});
</script>

<!-- keep for any shared functionality that your project already uses -->
<script src="/app.js" defer></script>
</body>
</html>
