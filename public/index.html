<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>COGgpt — Research Q&A</title>
  <link rel="stylesheet" href="/styles.css"/>
  <style>
    /* keep only an a11y helper locally to avoid a hard dependency */
    .visually-hidden {
      position: absolute !important;
      height: 1px; width: 1px;
      overflow: hidden; clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap; border: 0; padding: 0; margin: -1px;
    }
  </style>
</head>
<body>
  <header>
    <div class="header">
      <div class="title">
        <span class="title-cog">COG</span><span class="title-gpt">gpt</span><span class="beta-badge">(BETA)</span>
      </div>
      <div class="header-actions">
        <div id="who"></div>
        <!-- Admin-only client library dropdown (top-right, compact) -->
        <div id="libWrap" class="lib-wrap">
          <label for="client" class="visually-hidden">Client Library</label>
          <select id="client" class="lib-select">
            <option value="">Select a client library for your query</option>
          </select>
        </div>
        <a id="adminLink" class="btn ghost small" href="/admin" style="display:none;">Admin</a>
        <button id="logoutBtn" class="btn ghost small" title="Sign out">Sign out</button>
      </div>
    </div>
  </header>

  <main class="page">
    <div class="hero" style="display:flex;align-items:center;justify-content:space-between;gap:16px;margin:8px 0 18px">
      <div>
        <h1 style="font-size:34px;margin:0 0 6px">Ask about your research<span style="color:var(--orange)">.</span></h1>
        <p class="muted">Search across your uploaded reports, questionnaires, and data</p>
      </div>
      <div class="askrow" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div class="askbox" style="display:flex;flex:1;gap:12px;min-width:360px">
          <input id="q" class="input" placeholder="e.g., What has satisfaction for Evrysdi looked like over the past few years?" autocomplete="off"/>
          <button id="ask" class="btn-ask" disabled>Ask</button>
        </div>
        <div id="loader" class="loader"><span class="dotting"></span><span>Thinking…</span></div>
      </div>
    </div>

    <div id="msg" class="msg"></div>

    <!-- Full-width dashboard layout -->
    <div id="out" style="display:none;">
      <div class="grid">
        <div class="col">
          <div id="answerPanel" class="panel answer-panel" style="display:none;">
            <div id="answer" class="answer-body"></div>
          </div>

          <div id="supportCard" class="panel" style="display:none;">
            <h3>Additional Support</h3>
            <ul id="supportList"></ul>
            <button id="showMoreBtn" class="btn ghost small" style="display:none;">Show more</button>
          </div>

          <div id="quotesCard" class="panel" style="display:none;">
            <h3>Supporting Quotes</h3>
            <div id="quotes"></div>
          </div>

          <div id="slidesCard" class="panel" style="display:none;">
            <h3>Report Examples</h3>
            <div id="slidesGrid" class="slides-grid"></div>
          </div>
        </div>

        <div class="col">
          <div id="supportDataCard" class="panel" style="display:none;">
            <h3>Supporting Data</h3>
            <div id="chartWrap">
              <div id="chart">Chart will render here</div>
            </div>
          </div>

          <div id="refsCard" class="panel" style="display:none;">
            <h3>References</h3>
            <ol id="refs" class="refs-ol"></ol>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Populate dropdown live from Drive
    async function loadClientLibraries(){
      try {
        const res = await fetch("/api/client-libraries");
        const libs = await res.json();
        const sel = document.getElementById("client");
        sel.innerHTML = '<option value="">Select a client library for your query</option>';
        libs.forEach(({id, name})=>{
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = name;
          sel.appendChild(opt);
        });
      } catch(e) {
        console.error("Failed to load client libraries", e);
      }
    }
    loadClientLibraries();
  </script>

  <script src="/app.js" defer></script>
</body>
</html>
